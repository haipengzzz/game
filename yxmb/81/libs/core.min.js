function core(){this.material={animates:{},images:{},bgms:{},sounds:{},ground:null,items:{},enemys:{},icons:{},events:{}};this.timeout={getItemTipTimeout:null,turnHeroTimeout:null,};this.interval={heroMoveInterval:null,tipAnimate:null,openDoorAnimate:null,animateInterval:null,};this.animateFrame={background:null,globalAnimate:false,twoTime:null,fourTime:null,boxTime:null,moveTime:null,speed:null,weather:{time:null,type:null,level:0,nodes:[],data:null,}};this.musicStatus={audioContext:null,startDirectly:false,bgmStatus:false,soundStatus:true,playingBgm:null,isPlaying:false,};this.platform={isOnline:true,isPC:true,isAndroid:false,isIOS:false,isWeChat:false,isQQ:false,isChrome:false,supportCopy:false,fileInput:null,fileReader:null,successCallback:null,errorCallback:null,};this.domStyle={styles:[],scale:1,};this.initStatus={played:false,hero:{},floorId:null,thisMap:null,maps:null,checkBlock:{},lockControl:false,heroMoving:0,heroStop:true,automaticRoute:{autoHeroMove:false,autoStep:0,movedStep:0,destStep:0,destX:null,destY:null,autoStepRoutes:[],moveStepBeforeStop:[],lastDirection:null,cursorX:null,cursorY:null,moveDirectly:false,},downTime:null,route:[],replay:{replaying:false,pausing:false,animate:false,toReplay:[],totalList:[],speed:1},saveIndex:null,shops:{},event:{id:null,data:null,selection:null,ui:null,},textAttribute:{position:"center",title:[255,215,0,1],background:[0,0,0,0.85],text:[255,255,255,1],bold:false,},curtainColor:null,usingCenterFly:false,openingDoor:null,twoAnimateObjs:[],fourAnimateObjs:[],boxAnimateObjs:[],};this.status={}}core.prototype.init=function(c){for(var f in c){core[f]=c[f]}core.flags=core.clone(core.data.flags);core.values=core.clone(core.data.values);core.firstData=core.data.getFirstData();if(!core.flags.enableExperience){core.flags.enableLevelUp=false}if(!core.flags.canOpenBattleAnimate){core.flags.showBattleAnimateConfirm=false;core.flags.battleAnimate=false;core.setLocalStorage("battleAnimate",false)}core.firstData.shops.forEach(function(e){core.initStatus.shops[e.id]=e});core.dom.versionLabel.innerHTML=core.firstData.version;core.dom.logoLabel.innerHTML=core.firstData.title;document.title=core.firstData.title+" - HTML5魔塔";document.getElementById("startLogo").innerHTML=core.firstData.title;core.material.items=core.items.getItems();core.initStatus.maps=core.maps.initMaps(core.floorIds);core.material.enemys=core.clone(core.enemys.getEnemys());core.material.icons=core.icons.getIcons();core.material.events=core.events.getEvents();core.platform.isOnline=location.protocol.indexOf("http")==0;if(core.platform.isOnline){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext;try{core.musicStatus.audioContext=new window.AudioContext()}catch(d){console.log("该浏览器不支持AudioContext");core.musicStatus.audioContext=null}}["Android","iPhone","SymbianOS","Windows Phone","iPad","iPod"].forEach(function(e){if(navigator.userAgent.indexOf(e)>=0){if(e=="iPhone"||e=="iPad"||e=="iPod"){core.platform.isIOS=true}if(e=="Android"){core.platform.isAndroid=true}core.platform.isPC=false}});try{core.platform.supportCopy=document.queryCommandSupported("copy")}catch(d){core.platform.supportCopy=false}var a=/Chrome\/(\d+)\./i.exec(navigator.userAgent);if(core.isset(a)&&parseInt(a[1])>=50){core.platform.isChrome=true}core.platform.isSafari=/Safari/i.test(navigator.userAgent)&&!/Chrome/i.test(navigator.userAgent);core.platform.isQQ=/QQ/i.test(navigator.userAgent);core.platform.isWeChat=/MicroMessenger/i.test(navigator.userAgent);if(window.FileReader){core.platform.fileReader=new FileReader();core.platform.fileReader.onload=function(){var g=core.platform.fileReader.result;var i=null;try{i=JSON.parse(g);if(core.isset(i)){if(core.isset(core.platform.successCallback)){core.platform.successCallback(i)}return}}catch(h){console.log(h)}alert("不是有效的JSON文件！");if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}};core.platform.fileReader.onerror=function(){if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}}}if(core.platform.isPC){core.musicStatus.startDirectly=true}else{var b=navigator.connection;if(core.isset(b)&&b.type=="wifi"){core.musicStatus.startDirectly=true}}core.musicStatus.bgmStatus=core.getLocalStorage("bgmStatus",true);if(!core.musicStatus.startDirectly){core.musicStatus.bgmStatus=false}core.setLocalStorage("bgmStatus",core.musicStatus.bgmStatus);core.musicStatus.soundStatus=core.getLocalStorage("soundStatus",true);core.setLocalStorage("soundStatus",core.musicStatus.soundStatus);core.flags.battleAnimate=core.getLocalStorage("battleAnimate",core.flags.battleAnimate);core.flags.displayEnemyDamage=core.getLocalStorage("enemyDamage",core.flags.displayEnemyDamage);core.flags.displayExtraDamage=core.getLocalStorage("extraDamage",core.flags.displayExtraDamage);core.material.ground=new Image();core.material.ground.src="images/ground.png";core.loader(function(){console.log(core.material);core.material.icons.hero.height=core.material.images.hero.height/4;core.setRequestAnimationFrame();core.showStartAnimate()})};core.prototype.setRequestAnimationFrame=function(){(function(){var c=0;var d=["webkit","moz"];for(var e=0;e<d.length&&!window.requestAnimationFrame;++e){window.requestAnimationFrame=window[d[e]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[d[e]+"CancelAnimationFrame"]||window[d[e]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(f,h){var g=new Date().getTime();var j=Math.max(0,16.7-(g-c));var i=window.setTimeout(function(){f(g+j)},j);c=g+j;return i}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(f){clearTimeout(f)}}}());core.animateFrame.speed=core.values.animateSpeed;core.animateFrame.background=core.canvas.ui.createPattern(core.material.ground,"repeat");var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var a=function(g){core.animateFrame.twoTime=core.animateFrame.twoTime||g;core.animateFrame.fourTime=core.animateFrame.fourTime||g;core.animateFrame.boxTime=core.animateFrame.boxTime||g;core.animateFrame.moveTime=core.animateFrame.moveTime||g;core.animateFrame.weather.time=core.animateFrame.weather.time||g;if(core.animateFrame.globalAnimate&&core.isPlaying()){if(g-core.animateFrame.twoTime>core.animateFrame.speed&&core.isset(core.status.twoAnimateObjs)){for(var c=0;c<core.status.twoAnimateObjs.length;c++){var f=core.status.twoAnimateObjs[c];f.status=(f.status+1)%2;core.canvas.event.clearRect(f.x,f.y,32,32);core.canvas.event.drawImage(f.image,f.status*32,f.loc*32,32,32,f.x,f.y,32,32)}core.animateFrame.twoTime=g}if(g-core.animateFrame.fourTime>core.animateFrame.speed/2&&core.isset(core.status.fourAnimateObjs)){for(var c=0;c<core.status.fourAnimateObjs.length;c++){var f=core.status.fourAnimateObjs[c];f.status=(f.status+1)%4;core.canvas.event.clearRect(f.x,f.y,32,32);core.canvas.event.drawImage(f.image,f.status*32,f.loc*32,32,32,f.x,f.y,32,32)}core.animateFrame.fourTime=g}}if(g-core.animateFrame.boxTime>core.animateFrame.speed&&core.isset(core.status.boxAnimateObjs)&&core.status.boxAnimateObjs.length>0){core.drawBoxAnimate();core.animateFrame.boxTime=g}if(g-core.animateFrame.moveTime>16&&core.isset(core.status.heroMoving)&&core.status.heroMoving>0){var h=core.getHeroLoc("x"),i=core.getHeroLoc("y"),e=core.getHeroLoc("direction");if(core.status.heroMoving<=4){core.drawHero(e,h,i,"leftFoot",4*core.status.heroMoving*b[e].x,4*core.status.heroMoving*b[e].y)}else{if(core.status.heroMoving<=8){core.drawHero(e,h,i,"rightFoot",4*core.status.heroMoving*b[e].x,4*core.status.heroMoving*b[e].y)}}core.animateFrame.moveTime=g}if(core.isPlaying()&&g-core.animateFrame.weather.time>30){if(core.animateFrame.weather.type=="rain"&&core.animateFrame.weather.level>0){core.clearMap("weather",0,0,416,416);core.canvas.weather.strokeStyle="rgba(174,194,224,0.8)";core.canvas.weather.lineWidth=1;core.canvas.weather.lineCap="round";core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.beginPath();core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.lineTo(j.x+j.l*j.xs,j.y+j.l*j.ys);core.canvas.weather.stroke();j.x+=j.xs;j.y+=j.ys;if(j.x>416||j.y>416){j.x=Math.random()*416;j.y=-10}});core.canvas.weather.fill()}else{if(core.animateFrame.weather.type=="snow"&&core.animateFrame.weather.level>0){core.clearMap("weather",0,0,416,416);core.canvas.weather.fillStyle="rgba(255, 255, 255, 0.8)";core.canvas.weather.beginPath();if(!core.isset(core.animateFrame.weather.data)){core.animateFrame.weather.data=0}core.animateFrame.weather.data+=0.01;var d=core.animateFrame.weather.data;core.animateFrame.weather.nodes.forEach(function(j){core.canvas.weather.moveTo(j.x,j.y);core.canvas.weather.arc(j.x,j.y,j.r,0,Math.PI*2,true);j.x+=Math.sin(d)*2;j.y+=Math.cos(d+j.d)+1+j.r/2;if(j.x>416+5||j.x<-5||j.y>416){if(Math.random()>1/3){j.x=Math.random()*416;j.y=-10}else{if(Math.sin(d)>0){j.x=-5;j.y=Math.random()*416}else{j.x=416+5;j.y=Math.random()*416}}}});core.canvas.weather.fill()}}core.animateFrame.weather.time=g}window.requestAnimationFrame(a)};window.requestAnimationFrame(a)};core.prototype.showStartAnimate=function(a){core.dom.startPanel.style.opacity=1;core.dom.startPanel.style.display="block";core.dom.startTop.style.opacity=1;core.dom.startTop.style.display="block";core.dom.startButtonGroup.style.display="none";core.dom.startButtons.style.display="block";core.dom.levelChooseButtons.style.display="none";core.dom.curtain.style.background="#000000";core.dom.curtain.style.opacity=0;core.status.played=false;core.clearStatus();core.clearMap("all");var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startTop.style.display="none";core.dom.startButtonGroup.style.display="block";if(core.isset(a)){a()}}core.dom.startTop.style.opacity=b},20)};core.prototype.hideStartAnimate=function(a){var b=1;var c=window.setInterval(function(){b-=0.03;if(b<0){clearInterval(c);core.dom.startPanel.style.display="none";if(core.isset(a)){a()}}core.dom.startPanel.style.opacity=b},20)};core.prototype.setStartProgressVal=function(a){core.dom.startTopProgress.style.width=a+"%"};core.prototype.setStartLoadTipText=function(a){core.dom.startTopLoadTips.innerHTML=a};core.prototype.loader=function(c){var f=0,a=0,b=0;a=core.images.length;for(var e in core.sounds){b+=core.sounds[e].length}for(var d=0;d<core.images.length;d++){core.loadImage(core.images[d],function(h,g){core.setStartLoadTipText("正在加载图片 "+h+"...");core.material.images[h]=g;f++;core.setStartLoadTipText(h+" 加载完毕...");core.setStartProgressVal(f*(100/a));if(f==a){core.material.images.pngs={};if(core.pngs.length==0){core.loadAutotile(c);return}for(var i=0;i<core.pngs.length;i++){core.loadImage(core.pngs[i],function(k,j){core.material.images.pngs[k]=j;if(Object.keys(core.material.images.pngs).length==core.pngs.length){core.loadAutotile(c)}})}}})}};core.prototype.loadAutotile=function(b){core.material.images.autotile={};var a=Object.keys(core.material.icons.autotile);if(a.length==0){core.loadAnimates(b);return}for(var c=0;c<a.length;c++){core.loadImage(a[c],function(d,e){core.material.images.autotile[d]=e;if(Object.keys(core.material.images.autotile).length==a.length){core.loadAnimates(b)}})}};core.prototype.loadImage=function(d,a){try{core.setStartLoadTipText("加载图片 "+d+" 中...");var f=d;if(f.indexOf(".png")<0){f=f+".png"}var c=new Image();c.src="images/"+f+"?v="+main.version;if(c.complete){a(d,c);return}c.onload=function(){a(d,c)}}catch(b){alert(b)}};core.prototype.loadAnimates=function(a){core.animates.forEach(function(b){var c=new XMLHttpRequest();c.open("GET","animates/"+b+".animate",true);c.overrideMimeType("text/plain; charset=x-user-defined");c.onload=function(g){var d=this.responseText;try{d=JSON.parse(d);var f={};f.ratio=d.ratio;f.images=[];f.images_rev=[];d.bitmaps.forEach(function(k){if(!core.isset(k)||k==""){f.images.push(null)}else{try{var j=new Image();j.src=k;f.images.push(j)}catch(i){f.images.push(null)}}});f.frame=d.frame_max;f.frames=[];d.frames.forEach(function(i){var e=[];i.forEach(function(j){e.push({index:j[0],x:j[1],y:j[2],zoom:j[3],opacity:j[4],mirror:j[5]||0,angle:j[6]||0,})});f.frames.push(e)});core.material.animates[b]=f}catch(h){console.log(h);core.material.animates[b]=null}};c.ontimeout=function(d){console.log(d);core.material.animates[b]=null};c.onerror=function(d){console.log(d);core.material.animates[b]=null};c.send()});core.loadMusic(a)};core.prototype.loadMusic=function(a){core.bgms.forEach(function(c){if(/^.*\.mid$/i.test(c)){if(core.musicStatus.audioContext!=null){core.material.bgms[c]="loading";var d=new XMLHttpRequest();d.open("GET","sounds/"+c,true);d.overrideMimeType("text/plain; charset=x-user-defined");d.onload=function(f){try{var h=[];var i=this.responseText.length;for(var k=0;k<i;k++){h[k]=String.fromCharCode(this.responseText.charCodeAt(k)&255)}var j=core.material.bgms[c]=="starting";core.material.bgms[c]=AudioPlayer(core.musicStatus.audioContext,Replayer(MidiFile(h.join("")),Synth(44100)),true);if(j){core.playBgm(c)}}catch(g){console.log(g);core.material.bgms[c]=null}};d.ontimeout=function(f){console.log(f);core.material.bgms[c]=null};d.onerror=function(f){console.log(f);core.material.bgms[c]=null};d.send()}else{core.material.bgms[c]=null}}else{var b=new Audio();b.preload=core.musicStatus.startDirectly?"auto":"none";b.src="sounds/"+c;b.loop="loop";core.material.bgms[c]=b}});core.sounds.forEach(function(c){if(core.musicStatus.audioContext!=null){var d=new XMLHttpRequest();d.open("GET","sounds/"+c,true);d.responseType="arraybuffer";d.onload=function(f){try{core.musicStatus.audioContext.decodeAudioData(this.response,function(e){core.material.sounds[c]=e},function(h){console.log(h);core.material.sounds[c]=null})}catch(g){console.log(g);core.material.sounds[c]=null}};d.ontimeout=function(f){console.log(f);core.material.sounds[c]=null};d.onerror=function(f){console.log(f);core.material.sounds[c]=null};d.send()}else{var b=new Audio();b.src="sounds/"+c;core.material.sounds[c]=b}});if(core.musicStatus.startDirectly&&core.bgms.length>0){core.playBgm(core.bgms[0])}a()};core.prototype.isPlaying=function(){if(core.isset(core.status.played)&&core.status.played){return true}return false};core.prototype.clearStatus=function(){for(var a in core.interval){clearInterval(core.interval[a])}core.status={};core.clearStatusBar();core.resize(main.dom.body.clientWidth,main.dom.body.clientHeight)};core.prototype.resetStatus=function(c,b,a,f,e){for(var d in core.interval){clearInterval(core.interval[d])}core.status=core.clone(core.initStatus);core.status.played=true;core.status.floorId=a;core.status.maps=core.clone(e);core.material.enemys=core.clone(core.enemys.getEnemys());core.status.hero=core.clone(c);core.status.hard=b;if(core.isset(f)){core.status.route=f}core.status.saveIndex=core.getLocalStorage("saveIndex2",1);core.resize(main.dom.body.clientWidth,main.dom.body.clientHeight)};core.prototype.startGame=function(b,a){console.log("开始游戏");core.resetStatus(core.firstData.hero,b,core.firstData.floorId,null,core.initStatus.maps);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){if(core.isset(a)){a()}});setTimeout(function(){var c=new FormData();c.append("type","people");c.append("name",core.firstData.name);c.append("version",core.firstData.version);c.append("platform",core.platform.isPC?"PC":core.platform.isAndroid?"Android":core.platform.isIOS?"iOS":"");c.append("hard",b);c.append("hardCode",core.getFlag("hard",0));var d=new XMLHttpRequest();d.open("POST","/games/upload.php");d.send(c)})};core.prototype.restart=function(){core.showStartAnimate()};core.prototype.onkeyDown=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.isset(core.status.holdingKeys)){core.status.holdingKeys=[]}var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){return}}core.status.holdingKeys.push(a.keyCode);core.pressKey(a.keyCode)}else{core.keyDown(a.keyCode)}};core.prototype.onkeyUp=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(a.keyCode==27){core.stopReplay()}else{if(a.keyCode==90){core.rewindReplay()}else{if(a.keyCode==88){core.forwardReplay()}else{if(a.keyCode==32){core.triggerReplay()}}}}return}var c={37:true,38:true,39:true,40:true}[a.keyCode];if(c&&!core.status.lockControl){for(var b=0;b<core.status.holdingKeys.length;b++){if(core.status.holdingKeys[b]===a.keyCode){core.status.holdingKeys=core.status.holdingKeys.slice(0,b).concat(core.status.holdingKeys.slice(b+1));if(b===core.status.holdingKeys.length&&core.status.holdingKeys.length!==0){core.pressKey(core.status.holdingKeys.slice(-1)[0])}break}}core.keyUp(a.keyCode)}else{core.keyUp(a.keyCode)}};core.prototype.pressKey=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(a===core.status.holdingKeys.slice(-1)[0]){core.keyDown(a);window.setTimeout(function(){core.pressKey(a)},30)}};core.prototype.keyDown=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.lockControl){if(a==17){core.events.keyDownCtrl();return}if(core.status.event.id=="action"){core.events.keyDownAction(a);return}if(core.status.event.id=="book"){core.events.keyDownBook(a);return}if(core.status.event.id=="fly"){core.events.keyDownFly(a);return}if(core.status.event.id=="viewMaps"){core.events.keyDownViewMaps(a);return}if(core.status.event.id=="shop"){core.events.keyDownShop(a);return}if(core.status.event.id=="selectShop"){core.events.keyDownQuickShop(a);return}if(core.status.event.id=="toolbox"){core.events.keyDownToolbox(a);return}if(core.status.event.id=="save"||core.status.event.id=="load"){core.events.keyDownSL(a);return}if(core.status.event.id=="switchs"){core.events.keyDownSwitchs(a);return}if(core.status.event.id=="settings"){core.events.keyDownSettings(a);return}if(core.status.event.id=="syncSave"){core.events.keyDownSyncSave(a);return}if(core.status.event.id=="syncSelect"){core.events.keyDownSyncSelect(a);return}if(core.status.event.id=="localSaveSelect"){core.events.keyDownLocalSaveSelect(a);return}if(core.status.event.id=="cursor"){core.events.keyDownCursor(a);return}return}if(!core.status.played){return}switch(a){case 37:core.moveHero("left");break;case 38:core.moveHero("up");break;case 39:core.moveHero("right");break;case 40:core.moveHero("down");break;case 13:case 32:case 67:case 51:if(core.status.heroStop&&core.hasItem("centerFly")){if(core.status.usingCenterFly){if(core.canUseItem("centerFly")){core.useItem("centerFly");core.clearMap("ui",core.getHeroLoc("x")*32,core.getHeroLoc("y")*32,32,32)}else{core.drawTip("当前不能使用中心对称飞行器");core.clearMap("ui",(12-core.getHeroLoc("x"))*32,(12-core.getHeroLoc("y"))*32,32,32)}core.status.usingCenterFly=false}else{if(a==51){core.status.usingCenterFly=true;core.setAlpha("ui",0.5);core.fillRect("ui",(12-core.getHeroLoc("x"))*32,(12-core.getHeroLoc("y"))*32,32,32,core.canUseItem("centerFly")?"#00FF00":"#FF0000");core.setAlpha("ui",1);core.drawTip("请确认当前中心对称飞行器的位置")}}}break}if(core.status.usingCenterFly&&a!=51){core.clearMap("ui",(12-core.getHeroLoc("x"))*32,(12-core.getHeroLoc("y"))*32,32,32);core.status.usingCenterFly=false}};core.prototype.keyUp=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.lockControl){core.status.holdingKeys=[];if(core.status.event.id=="text"&&(a==13||a==32||a==67)){core.drawText();return}if(core.status.event.id=="confirmBox"){core.events.keyUpConfirmBox(a);return}if(core.status.event.id=="action"){core.events.keyUpAction(a);return}if(core.status.event.id=="about"&&(a==13||a==32||a==67)){core.events.clickAbout();return}if(core.status.event.id=="book"){core.events.keyUpBook(a);return}if(core.status.event.id=="book-detail"&&(a==13||a==32||a==67)){core.events.clickBookDetail();return}if(core.status.event.id=="fly"){core.events.keyUpFly(a);return}if(core.status.event.id=="viewMaps"){core.events.keyUpViewMaps(a);return}if(core.status.event.id=="shop"){core.events.keyUpShop(a);return}if(core.status.event.id=="selectShop"){core.events.keyUpQuickShop(a);return}if(core.status.event.id=="toolbox"){core.events.keyUpToolbox(a);return}if(core.status.event.id=="save"||core.status.event.id=="load"){core.events.keyUpSL(a);return}if(core.status.event.id=="switchs"){core.events.keyUpSwitchs(a);return}if(core.status.event.id=="settings"){core.events.keyUpSettings(a);return}if(core.status.event.id=="syncSave"){core.events.keyUpSyncSave(a);return}if(core.status.event.id=="syncSelect"){core.events.keyUpSyncSelect(a);return}if(core.status.event.id=="localSaveSelect"){core.events.keyUpLocalSaveSelect(a);return}if(core.status.event.id=="cursor"){core.events.keyUpCursor(a);return}return}if(!core.status.played){return}switch(a){case 27:if(core.status.heroStop){core.openSettings(true)}break;case 71:if(core.status.heroStop){core.useFly(true)}break;case 88:if(core.status.heroStop){core.openBook(true)}break;case 65:core.doSL("autoSave","load");break;case 83:if(core.status.heroStop){core.save(true)}break;case 68:if(core.status.heroStop){core.load(true)}break;case 69:if(core.status.heroStop){core.ui.drawCursor()}break;case 84:if(core.status.heroStop){core.openToolbox(true)}break;case 90:if(core.status.heroStop){core.turnHero()}break;case 75:if(core.status.heroStop){core.openQuickShop(true)}break;case 32:if(!core.status.lockControl&&core.status.heroStop){core.getNextItem()}break;case 72:if(!core.status.lockControl&&core.status.heroStop){core.ui.drawHelp()}break;case 82:if(!core.status.lockControl&&core.status.heroStop){core.ui.drawConfirmBox("确定要回放录像吗？",function(){core.ui.closePanel();var b=core.status.hard,c=core.clone(core.status.route);core.resetStatus(core.firstData.hero,b,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(b);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(c)})},function(){core.ui.closePanel()})}break;case 33:case 34:if(core.status.heroStop){if(core.flags.enableViewMaps){core.ui.drawMaps(core.floorIds.indexOf(core.status.floorId))}else{core.drawTip("本塔不允许浏览地图！")}}break;case 37:break;case 38:break;case 39:break;case 40:break;case 49:if(core.status.heroStop&&core.hasItem("pickaxe")){if(core.canUseItem("pickaxe")){core.useItem("pickaxe")}else{core.drawTip("当前不能使用破墙镐")}}break;case 50:if(core.status.heroStop){if(core.hasItem("bomb")){if(core.canUseItem("bomb")){core.useItem("bomb")}else{core.drawTip("当前不能使用炸弹")}}else{if(core.hasItem("hammer")){if(core.canUseItem("hammer")){core.useItem("hammer")}else{core.drawTip("当前不能使用圣锤")}}}}break}if(core.isset(core.status.automaticRoute)&&core.status.automaticRoute.autoHeroMove){core.stopAutomaticRoute()}core.stopHero()};core.prototype.ondown=function(b,c){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.status.played||core.status.lockControl){core.onclick(b,c,[]);return}core.status.downTime=new Date();core.saveCanvas("ui");core.clearMap("ui",0,0,416,416);var a={x:b,y:c};core.status.stepPostfix=[];core.status.stepPostfix.push(a);core.fillPosWithPoint(a)};core.prototype.onmove=function(g,h){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}var e={x:g,y:h};var f=core.status.stepPostfix[core.status.stepPostfix.length-1];var a=[e.y-f.y,f.x-e.x,f.y-e.y,e.x-f.x];var d=0,c=4;for(var b=0;b<4;b++){if(a[b]>d){c=b;d=a[b]}}e=[{x:0,y:1},{x:-1,y:0},{x:0,y:-1},{x:1,y:0},false][c];if(e){e.x+=f.x;e.y+=f.y;core.status.stepPostfix.push(e);core.fillPosWithPoint(e)}};core.prototype.onup=function(){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.stepPostfix.length>0){var g=[];var a={"0":{"1":"down","-1":"up"},"-1":{"0":"left"},"1":{"0":"right"}};for(var b=1;b<core.status.stepPostfix.length;b++){var d=core.status.stepPostfix[b-1];var c=core.status.stepPostfix[b];g.push({direction:a[c.x-d.x][c.y-d.y],x:c.x,y:c.y})}var e=core.status.stepPostfix[0].x;var f=core.status.stepPostfix[0].y;core.status.stepPostfix=[];if(!core.status.lockControl){core.canvas.ui.clearRect(0,0,416,416);core.canvas.ui.restore()}if(!core.status.lockControl&&g.length==0&&core.status.downTime!=null&&new Date()-core.status.downTime>=1000){core.events.longClick()}else{core.onclick(e,f,g)}core.status.downTime=null}};core.prototype.getClickLoc=function(f,g){var d={x:0,y:0};var c=32;c=c*core.domStyle.scale;switch(core.domStyle.screenMode){case"vertical":d.x=0;d.y=core.dom.statusBar.offsetHeight+3;break;case"horizontal":case"bigScreen":d.x=core.dom.statusBar.offsetWidth+3;d.y=0;break}var a=core.dom.gameGroup.offsetLeft+d.x;var e=core.dom.gameGroup.offsetTop+d.y;var b={x:f-a,y:g-e,size:c};return b};core.prototype.onclick=function(b,c,a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}a=a||[];if(b<0||c<0||b>12||c>12){return}if(core.status.usingCenterFly){if(b!=12-core.getHeroLoc("x")||c!=12-core.getHeroLoc("y")){core.clearMap("ui",(12-core.getHeroLoc("x"))*32,(12-core.getHeroLoc("y"))*32,32,32)}else{if(core.canUseItem("centerFly")){core.useItem("centerFly");core.clearMap("ui",core.getHeroLoc("x")*32,core.getHeroLoc("y")*32,32,32);return}else{core.drawTip("当前不能使用中心对称飞行器");core.clearMap("ui",(12-core.getHeroLoc("x"))*32,(12-core.getHeroLoc("y"))*32,32,32)}}core.status.usingCenterFly=false}if(!core.status.lockControl){core.setAutomaticRoute(b,c,a);return}if(core.status.event.id=="book"){core.events.clickBook(b,c);return}if(core.status.event.id=="book-detail"){core.events.clickBookDetail(b,c);return}if(core.status.event.id=="fly"){core.events.clickFly(b,c);return}if(core.status.event.id=="viewMaps"){core.events.clickViewMaps(b,c);return}if(core.status.event.id=="switchs"){core.events.clickSwitchs(b,c);return}if(core.status.event.id=="settings"){core.events.clickSettings(b,c);return}if(core.status.event.id=="shop"){core.events.clickShop(b,c);return}if(core.status.event.id=="selectShop"){core.events.clickQuickShop(b,c);return}if(core.status.event.id=="toolbox"){core.events.clickToolbox(b,c);return}if(core.status.event.id=="save"||core.status.event.id=="load"){core.events.clickSL(b,c);return}if(core.status.event.id=="confirmBox"){core.events.clickConfirmBox(b,c);return}if(core.status.event.id=="keyBoard"){core.events.clickKeyBoard(b,c);return}if(core.status.event.id=="about"){core.events.clickAbout(b,c);return}if(core.status.event.id=="action"){core.events.clickAction(b,c);return}if(core.status.event.id=="text"){core.drawText();return}if(core.status.event.id=="syncSave"){core.events.clickSyncSave(b,c);return}if(core.status.event.id=="syncSelect"){core.events.clickSyncSelect(b,c);return}if(core.status.event.id=="localSaveSelect"){core.events.clickLocalSaveSelect(b,c);return}if(core.status.event.id=="cursor"){core.events.clickCursor(b,c);return}};core.prototype.onmousewheel=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.lockControl&&core.status.event.id=="fly"){if(a==1){core.ui.drawFly(core.status.event.data+1)}if(a==-1){core.ui.drawFly(core.status.event.data-1)}return}if(core.status.lockControl&&core.status.event.id=="book"){if(a==1){core.ui.drawBook(core.status.event.data-6)}if(a==-1){core.ui.drawBook(core.status.event.data+6)}return}if(core.status.lockControl&&(core.status.event.id=="save"||core.status.event.id=="load")){if(a==1){core.ui.drawSLPanel(core.status.event.data-10)}if(a==-1){core.ui.drawSLPanel(core.status.event.data+10)}return}if(core.status.lockControl&&core.status.event.id=="viewMaps"){if(a==1){core.ui.drawMaps(core.status.event.data+1)}if(a==-1){core.ui.drawMaps(core.status.event.data-1)}return}};core.prototype.clearAutomaticRouteNode=function(a,b){if(core.status.event.id==null){core.canvas.ui.clearRect(a*32+5,b*32+5,27,27)}};core.prototype.stopAutomaticRoute=function(){if(!core.status.played){return}core.status.automaticRoute.autoHeroMove=false;core.status.automaticRoute.autoStep=0;core.status.automaticRoute.destStep=0;core.status.automaticRoute.movedStep=0;core.status.automaticRoute.autoStepRoutes=[];core.status.automaticRoute.destX=null;core.status.automaticRoute.destY=null;core.status.automaticRoute.lastDirection=null;core.stopHero();if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.canvas.ui.clearRect(0,0,416,416)}};core.prototype.continueAutomaticRoute=function(){var a=core.status.automaticRoute.moveStepBeforeStop;if(a.length===0||(a.length===1&&a[0].step===1)){core.status.automaticRoute.moveStepBeforeStop=[]}else{core.setAutoHeroMove(a)}};core.prototype.clearContinueAutomaticRoute=function(){core.canvas.ui.clearRect(0,0,416,416);core.status.automaticRoute.moveStepBeforeStop=[]};core.prototype.setAutomaticRoute=function(a,b,h){if(!core.status.played||core.status.lockControl){return}if(core.status.automaticRoute.autoHeroMove){var c=core.status.automaticRoute.destX,d=core.status.automaticRoute.destY;core.stopAutomaticRoute();if(c==a&&d==b){core.status.automaticRoute.moveDirectly=true;setTimeout(function(){if(core.status.automaticRoute.moveDirectly){if(core.canMoveDirectly(a,b)){core.clearMap("hero",0,0,416,416);core.setHeroLoc("x",a);core.setHeroLoc("y",b);core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");core.status.route.push("move:"+a+":"+b)}}core.status.automaticRoute.moveDirectly=false},100)}return}if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y&&h.length==0){if(core.timeout.turnHeroTimeout==null){core.timeout.turnHeroTimeout=setTimeout(function(){core.turnHero();clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null},250)}else{clearTimeout(core.timeout.turnHeroTimeout);core.timeout.turnHeroTimeout=null;core.getNextItem()}return}var g=0;var i=null;var f;if(!(f=core.automaticRoute(a,b))){if(a==core.status.hero.loc.x&&b==core.status.hero.loc.y){f=[]}else{core.canvas.ui.clearRect(0,0,416,416);return}}f=f.concat(h);core.status.automaticRoute.destX=a;core.status.automaticRoute.destY=b;core.canvas.ui.save();core.canvas.ui.clearRect(0,0,416,416);core.canvas.ui.fillStyle="#bfbfbf";core.canvas.ui.strokeStyle="#bfbfbf";core.canvas.ui.lineWidth=8;for(var e=0;e<f.length;e++){if(i==null){g++;i=f[e].direction}else{if(i==f[e].direction){g++}else{core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});g=1;i=f[e].direction}}if(e==f.length-1){core.status.automaticRoute.autoStepRoutes.push({direction:i,step:g});core.canvas.ui.fillRect(f[e].x*32+10,f[e].y*32+10,12,12)}else{core.canvas.ui.beginPath();if(core.isset(f[e+1])&&i!=f[e+1].direction){if(i=="up"&&f[e+1].direction=="left"||i=="right"&&f[e+1].direction=="down"){core.canvas.ui.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="up"&&f[e+1].direction=="right"||i=="left"&&f[e+1].direction=="down"){core.canvas.ui.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+27)}else{if(i=="left"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="right"){core.canvas.ui.moveTo(f[e].x*32+27,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+5)}else{if(i=="right"&&f[e+1].direction=="up"||i=="down"&&f[e+1].direction=="left"){core.canvas.ui.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+5)}}}}core.canvas.ui.stroke();continue}switch(i){case"up":case"down":core.canvas.ui.beginPath();core.canvas.ui.moveTo(f[e].x*32+16,f[e].y*32+5);core.canvas.ui.lineTo(f[e].x*32+16,f[e].y*32+27);core.canvas.ui.stroke();break;case"left":case"right":core.canvas.ui.beginPath();core.canvas.ui.moveTo(f[e].x*32+5,f[e].y*32+16);core.canvas.ui.lineTo(f[e].x*32+27,f[e].y*32+16);core.canvas.ui.stroke();break}}}core.canvas.ui.restore();core.setAutoHeroMove()};core.prototype.automaticRoute=function(d,e){var x=core.getHeroLoc("x");var y=core.getHeroLoc("y");var w={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var u=[];var n=0;var v=[];var a=[];if(d==x&&e==y){return false}u.push(13*x+y);u.push(-1);v[13*x+y]="";while(u.length!=1){var i=u.shift();if(i===-1){n+=1;u.push(-1);continue}var b=~~(i/169);if(b!==n){u.push(i);continue}i=i%169;var q=parseInt(i/13),r=i%13;var p=false,o,m=core.getBlock(q,r);for(var h in w){if(!core.canMoveHero(q,r,h)){continue}var s=q+w[h].x;var t=r+w[h].y;if(s<0||s>12||t<0||t>12){continue}var l=13*s+t;if(core.isset(v[l])){continue}var c=1;var k,j=core.getBlock(s,t);if(j!=null){k=j.block.event.id;if(k=="light"){c=100}if(k.substring(k.length-3)=="Net"){c=core.values.lavaDamage}if(!core.flags.potionWhileRouting&&k.substring(k.length-6)=="Potion"){c=20}if(j.block.event.trigger=="changeFloor"){c=10}}if(core.status.checkBlock.damage[l]>0){c=core.status.checkBlock.damage[l]}if(s==d&&t==e){v[l]=h;break}if(core.noPassExists(s,t)){continue}v[l]=h;u.push(169*(n+c)+l)}if(core.isset(v[13*d+e])){break}}if(!core.isset(v[13*d+e])){return false}var q=d,r=e;while(q!=x||r!=y){var g=v[13*q+r];a.push({direction:g,x:q,y:r});q-=w[g].x;r-=w[g].y}a.reverse();return a};core.prototype.fillPosWithPoint=function(a){core.fillRect("ui",a.x*32+12,a.y*32+12,8,8,"#bfbfbf")};core.prototype.setAutoHeroMove=function(a){a=a||core.status.automaticRoute.autoStepRoutes;if(a.length==0){return}core.status.automaticRoute.autoStepRoutes=a;core.status.automaticRoute.autoHeroMove=true;core.status.automaticRoute.autoStep=1;core.status.automaticRoute.destStep=a[0].step;core.moveHero(a[0].direction)};core.prototype.setHeroMoveInterval=function(b,d,e,a){if(core.status.heroMoving>0){return}core.status.heroMoving=1;var c={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.interval.heroMoveInterval=window.setInterval(function(){core.status.heroMoving++;if(core.status.heroMoving==8){core.setHeroLoc("x",d+c[b].x);core.setHeroLoc("y",e+c[b].y);core.moveOneStep();core.clearMap("hero",0,0,416,416);core.drawHero(b,core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");clearInterval(core.interval.heroMoveInterval);core.status.heroMoving=0;if(core.isset(a)){a()}}},12.5/core.status.replay.speed)};core.prototype.moveAction=function(a){if(core.interval.openDoorAnimate!=null){return}if(core.status.heroMoving>0){return}var e={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var c=core.getHeroLoc("direction");var f=core.getHeroLoc("x");var g=core.getHeroLoc("y");var d=core.noPass(f+e[c].x,g+e[c].y),b=core.canMoveHero();if(d||!b){if(core.status.event.id!="ski"){core.status.route.push(c)}core.status.automaticRoute.moveStepBeforeStop=[];if(b){core.trigger(f+e[c].x,g+e[c].y)}core.drawHero(c,f,g,"stop");if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}if(core.isset(a)){a()}}else{core.setHeroMoveInterval(c,f,g,function(){if(core.status.automaticRoute.autoHeroMove){core.status.automaticRoute.movedStep++;core.status.automaticRoute.lastDirection=core.getHeroLoc("direction");if(core.status.automaticRoute.destStep==core.status.automaticRoute.movedStep){if(core.status.automaticRoute.autoStep==core.status.automaticRoute.autoStepRoutes.length){core.clearContinueAutomaticRoute();core.stopAutomaticRoute()}else{core.status.automaticRoute.movedStep=0;core.status.automaticRoute.destStep=core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].step;core.setHeroLoc("direction",core.status.automaticRoute.autoStepRoutes[core.status.automaticRoute.autoStep].direction);core.status.automaticRoute.autoStep++}}}else{if(core.status.heroStop){core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop")}}if(core.status.event.id!="ski"){core.status.route.push(c)}core.trigger(core.getHeroLoc("x"),core.getHeroLoc("y"));core.checkBlock();if(core.isset(a)){a()}})}};core.prototype.turnHero=function(){if(core.status.hero.loc.direction=="up"){core.status.hero.loc.direction="right"}else{if(core.status.hero.loc.direction=="right"){core.status.hero.loc.direction="down"}else{if(core.status.hero.loc.direction=="down"){core.status.hero.loc.direction="left"}else{if(core.status.hero.loc.direction=="left"){core.status.hero.loc.direction="up"}}}}core.drawHero(core.status.hero.loc.direction,core.status.hero.loc.x,core.status.hero.loc.y,"stop",0,0);core.canvas.ui.clearRect(0,0,416,416);core.status.route.push("turn")};core.prototype.canMoveHero=function(k,l,b,c){if(!core.isset(k)){k=core.getHeroLoc("x")}if(!core.isset(l)){l=core.getHeroLoc("y")}if(!core.isset(b)){b=core.getHeroLoc("direction")}if(!core.isset(c)){c=core.status.floorId}if(core.isset(core.floors[c].cannotMove)){var a=core.floors[c].cannotMove[k+","+l];if(core.isset(a)&&a instanceof Array&&a.indexOf(b)>=0){return false}}var h=core.getBlock(k,l,c);if(h!=null){nowId=h.block.event.id;var i=nowId.slice(0,5).toLowerCase()=="arrow";if(i){var g=nowId.slice(5).toLowerCase();if(b!=g){return false}}}var j={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var f=core.getBlock(k+j[b].x,l+j[b].y,c);if(f!=null){nextId=f.block.event.id;var d=nextId.slice(0,5).toLowerCase()=="arrow";if(d){var e=nextId.slice(5).toLowerCase();if((j[b].x+j[e].x)==0&&(j[b].y+j[e].y)==0){return false}}}return true};core.prototype.canMoveDirectly=function(a,b){if(!core.flags.enableMoveDirectly){return false}if(core.hasFlag("poison")){return false}var e=core.getHeroLoc("x"),f=core.getHeroLoc("y");if(e==a&&f==b){return false}if(core.getBlock(e,f)!=null||core.status.checkBlock.damage[13*e+f]>0){return false}var m=[],l=[];m[13*e+f]=true;l.push(13*e+f);var d=[[-1,0],[1,0],[0,1],[0,-1]];while(l.length>0){var g=l.shift(),h=parseInt(g/13),i=g%13;for(var c in d){var j=h+d[c][0],k=i+d[c][1];if(j<0||j>=13||k<0||k>=13||m[13*j+k]||core.getBlock(j,k)!=null||core.status.checkBlock.damage[13*j+k]>0){continue}if(j==a&&k==b){return true}m[13*j+k]=true;l.push(13*j+k)}}return false};core.prototype.moveHero=function(b,a){if(core.status.heroMoving>0){return}if(core.isset(b)){core.setHeroLoc("direction",b)}if(!core.isset(a)){core.status.heroStop=false;core.status.automaticRoute.moveDirectly=false;var c=function(){if(!core.status.heroStop){core.moveAction();setTimeout(c,50)}else{core.stopHero()}};c()}else{core.moveAction(function(){a()})}};core.prototype.eventMoveHero=function(f,g,b){g=g||100;core.clearMap("ui",0,0,416,416);core.setAlpha("ui",1);var c=[];f.forEach(function(h){if(typeof h=="string"){c.push(h)}else{if(!core.isset(h.value)){c.push(h.direction)}else{for(var j=0;j<h.value;j++){c.push(h.direction)}}}});var e=0;var d={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};core.status.replay.animate=true;var a=window.setInterval(function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");if(c.length==0){clearInterval(a);core.drawHero(core.getHeroLoc("direction"),i,j,"stop");core.status.replay.animate=false;if(core.isset(b)){b()}}else{var h=c[0];core.setHeroLoc("direction",h);e++;if(e<=4){core.drawHero(h,i,j,"leftFoot",4*e*d[h].x,4*e*d[h].y)}else{if(e<=8){core.drawHero(h,i,j,"rightFoot",4*e*d[h].x,4*e*d[h].y)}}if(e==8){e=0;core.setHeroLoc("x",i+d[h].x);core.setHeroLoc("y",j+d[h].y);c.shift()}}},g/8/core.status.replay.speed)};core.prototype.moveOneStep=function(){core.status.hero.steps++;if(core.hasFlag("poison")){core.status.hero.hp-=core.values.poisonDamage;if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose("poison");return}core.updateStatusBar()}};core.prototype.waitHeroToStop=function(a){core.stopAutomaticRoute();core.clearContinueAutomaticRoute();if(core.isset(a)){core.status.replay.animate=true;core.lockControl();core.status.automaticRoute.moveDirectly=false;setTimeout(function(){core.status.replay.animate=false;core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");a()},30)}};core.prototype.stopHero=function(){core.status.heroStop=true};core.prototype.drawHero=function(a,i,j,h,f,g){f=f||0;g=g||0;var b=f==0?0:f/Math.abs(f),c=g==0?0:g/Math.abs(g);core.clearAutomaticRouteNode(i+b,j+c);var e=core.material.icons.hero[a];i=i*32;j=j*32;core.canvas.hero.clearRect(i-32,j-32,96,96);var d=core.material.icons.hero.height;core.canvas.hero.drawImage(core.material.images.hero,e[h]*32,e.loc*d,32,d,i+f,j+g+32-d,32,d)};core.prototype.setHeroLoc=function(a,b){if(b=="++"){core.status.hero.loc[a]++;return}else{if(b=="--"){core.status.hero.loc[a]--;return}}core.status.hero.loc[a]=b};core.prototype.getHeroLoc=function(a){if(!core.isset(a)){return core.status.hero.loc}return core.status.hero.loc[a]};core.prototype.nextX=function(){var a={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("x")+a[core.getHeroLoc("direction")].x};core.prototype.nextY=function(){var a={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};return core.getHeroLoc("y")+a[core.getHeroLoc("direction")].y};core.prototype.openDoor=function(d,i,j,f,a){if(core.interval.openDoorAnimate!=null){return}if(!core.terrainExists(i,j,d)){if(core.isset(a)){a()}return}if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopAutomaticRoute();var g=30;if(f){var e=d.replace("Door","Key");if(!core.hasItem(e)){if(e!="specialKey"){core.drawTip("你没有"+core.material.items[e].name)}else{core.drawTip("无法开启此门")}core.clearContinueAutomaticRoute();return}core.autosave(true);core.removeItem(e)}core.playSound("door.ogg");var h=0;var c=d;if(!(c.substring(c.length-4)=="Door")){c=c+"Door";g=100}var b=core.material.icons.animates[c];core.status.replay.animate=true;core.interval.openDoorAnimate=window.setInterval(function(){h++;if(h==4){clearInterval(core.interval.openDoorAnimate);core.interval.openDoorAnimate=null;core.removeBlock(i,j);core.status.replay.animate=false;core.events.afterOpenDoor(d,i,j,a);return}core.canvas.event.clearRect(32*i,32*j,32,32);core.canvas.event.drawImage(core.material.images.animates,32*h,32*b,32,32,32*i,32*j,32,32)},g)};core.prototype.battle=function(d,e,f,c,a){if(core.status.automaticRoute.moveStepBeforeStop.length==0){core.status.automaticRoute.moveStepBeforeStop=core.status.automaticRoute.autoStepRoutes.slice(core.status.automaticRoute.autoStep-1,core.status.automaticRoute.autoStepRoutes.length);if(core.status.automaticRoute.moveStepBeforeStop.length>=1){core.status.automaticRoute.moveStepBeforeStop[0].step-=core.status.automaticRoute.movedStep}}core.stopHero();core.stopAutomaticRoute();var b=core.enemys.getDamage(d);if(b>=core.status.hero.hp&&!c){core.drawTip("你打不过此怪物！");core.clearContinueAutomaticRoute();return}if(!core.isset(core.status.event.id)){core.autosave(true)}if(core.flags.battleAnimate&&!core.status.replay.replaying){core.waitHeroToStop(function(){core.ui.drawBattleAnimate(d,function(){core.afterBattle(d,e,f,a)})})}else{if(core.flags.equipment&&core.getFlag("sword","sword0")!="sword0"){core.playSound("zone.ogg");core.drawAnimate("sword",e,f)}else{core.playSound("attack.ogg");core.drawAnimate("hand",e,f)}core.afterBattle(d,e,f,a)}};core.prototype.afterBattle=function(d,f,g,a){core.status.hero.hp-=core.enemys.getDamage(d);if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose("battle");return}var e=core.material.enemys[d].money;if(core.hasItem("coin")){e*=2}if(core.hasFlag("curse")){e=0}core.status.hero.money+=e;var b=core.material.enemys[d].experience;if(core.hasFlag("curse")){b=0}core.status.hero.experience+=b;if(core.isset(f)&&core.isset(g)){core.removeBlock(f,g);core.canvas.event.clearRect(32*f,32*g,32,32)}var c="打败 "+core.material.enemys[d].name;if(core.flags.enableMoney){c+="，金币+"+e}if(core.flags.enableExperience){c+="，经验+"+b}core.drawTip(c);core.events.afterBattle(d,f,g,a)};core.prototype.trigger=function(g,h){var d=core.status.thisMap.blocks;var e;for(var a=0;a<d.length;a++){if(d[a].x==g&&d[a].y==h&&!(core.isset(d[a].enable)&&!d[a].enable)){e=d[a].event&&d[a].event.noPass;if(e){core.clearAutomaticRouteNode(g,h)}if(core.isset(d[a].event)&&core.isset(d[a].event.trigger)){var f=d[a].event.trigger;if(f=="changeFloor"&&!e){var c=core.flags.portalWithoutTrigger;if(core.isset(d[a].event.data)&&core.isset(d[a].event.data.portalWithoutTrigger)){c=d[a].event.data.portalWithoutTrigger}if(c){if(core.status.replay.replaying){if(core.status.replay.toReplay[0]=="no"){core.status.replay.toReplay.shift();core.status.route.push("no");continue}}else{if(core.status.automaticRoute.autoHeroMove||core.status.automaticRoute.autoStep<core.status.automaticRoute.autoStepRoutes.length){core.status.route.push("no");continue}}}}core.status.automaticRoute.moveDirectly=false;core.material.events[f](d[a],core,function(b){})}}}};core.prototype.changeFloor=function(d,g,e,h,b){var c=!(h==0)&&!core.status.replay.replaying;h=h||800;h/=20;core.lockControl();core.stopHero();core.stopAutomaticRoute();core.clearContinueAutomaticRoute();core.status.replay.animate=true;core.dom.floorNameLabel.innerHTML=core.status.maps[d].title;if(!core.isset(g)&&!core.isset(e)){e=core.status.hero.loc}if(core.isset(g)){if(!core.isset(e)){e={}}var a=core.status.maps[d].blocks;for(var f in a){if(core.isset(a[f].event)&&!(core.isset(a[f].enable)&&!a[f].enable)&&a[f].event.id===g){e.x=a[f].x;e.y=a[f].y;break}}if(!core.isset(e.x)){e.x=core.status.hero.loc.x;e.y=core.status.hero.loc.y}}if(core.status.maps[d].canFlyTo&&core.status.hero.flyRange.indexOf(d)<0){if(core.floorIds.indexOf(d)>core.floorIds.indexOf(core.status.floorId)){core.status.hero.flyRange.push(d)}else{core.status.hero.flyRange.unshift(d)}}window.setTimeout(function(){var i=function(){var k=core.status.maps[d].name;if(!core.isset(k)||k==""){k="&nbsp;"}core.statusBar.floor.innerHTML=k;if(/^[+-]?\d+$/.test(k)){core.statusBar.floor.style.fontStyle="italic"}else{core.statusBar.floor.style.fontStyle="normal"}if(core.isset(core.floors[d].bgm)){core.playBgm(core.floors[d].bgm)}if(core.status.event.id==null){if(core.isset(core.floors[d].color)){var j=core.floors[d].color;core.dom.curtain.style.background=core.arrayToRGB(j);if(core.isset(j[3])){core.dom.curtain.style.opacity=j[3]}else{core.dom.curtain.style.opacity=1}core.status.curtainColor=j}else{core.dom.curtain.style.background="#000000";core.dom.curtain.style.opacity=0}}if(core.isset(core.floors[d].weather)){core.setWeather(core.floors[d].weather[0],core.floors[d].weather[1])}else{core.setWeather()}core.drawMap(d,function(){setTimeout(function(){if(core.isset(e.direction)){core.setHeroLoc("direction",e.direction)}core.setHeroLoc("x",e.x);core.setHeroLoc("y",e.y);core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");core.updateStatusBar();var l=function(){core.unLockControl();core.status.replay.animate=false;core.events.afterChangeFloor(d);if(core.isset(b)){b()}};if(c){core.mapChangeAnimate("hide",h/4,function(){l()})}else{l()}},25)})};core.playSound("floor.mp3");if(c){core.mapChangeAnimate("show",h/2,function(){i()})}else{i()}},25)};core.prototype.mapChangeAnimate=function(b,c,a){if(b=="show"){core.show(core.dom.floorMsgGroup,c,function(){a()})}else{core.hide(core.dom.floorMsgGroup,c,function(){a()})}};core.prototype.clearMap=function(c,e,f,d,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].clearRect(0,0,416,416)}}else{core.canvas[c].clearRect(e,f,d,a)}};core.prototype.fillText=function(b,d,e,f,c,a){if(core.isset(c)){core.setFillStyle(b,c)}if(core.isset(a)){core.setFont(b,a)}core.canvas[b].fillText(d,e,f)};core.prototype.fillRect=function(b,e,f,d,a,c){if(core.isset(c)){core.setFillStyle(b,c)}core.canvas[b].fillRect(e,f,d,a)};core.prototype.strokeRect=function(c,f,g,e,a,d,b){if(core.isset(d)){core.setStrokeStyle(c,d)}if(core.isset(b)){core.setLineWidth(c,b)}core.canvas[c].strokeRect(f,g,e,a)};core.prototype.drawLine=function(b,d,f,e,g,c,a){if(core.isset(c)){core.setStrokeStyle(b,c)}if(core.isset(a)){core.setLineWidth(b,a)}core.canvas[b].beginPath();core.canvas[b].moveTo(d,f);core.canvas[b].lineTo(e,g);core.canvas[b].closePath();core.canvas[b].stroke()};core.prototype.setFont=function(b,a){core.canvas[b].font=a};core.prototype.setLineWidth=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].lineWidth=a}}core.canvas[c].lineWidth=a};core.prototype.saveCanvas=function(a){core.canvas[a].save()};core.prototype.loadCanvas=function(a){core.canvas[a].restore()};core.prototype.setStrokeStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].strokeStyle=c}}else{core.canvas[b].strokeStyle=c}};core.prototype.setAlpha=function(c,a){if(c=="all"){for(var b in core.canvas){core.canvas[b].globalAlpha=a}}else{core.canvas[c].globalAlpha=a}};core.prototype.setOpacity=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].canvas.style.opacity=c}}else{core.canvas[b].canvas.style.opacity=c}};core.prototype.setFillStyle=function(b,c){if(b=="all"){for(var a in core.canvas){core.canvas[a].fillStyle=c}}else{core.canvas[b].fillStyle=c}};core.prototype.drawMap=function(k,f){var j=core.status.maps[k];var i=j.blocks;core.status.floorId=k;core.status.thisMap=j;core.clearMap("all");core.removeGlobalAnimate(null,null,true);var g=core.floors[k].defaultGround||"ground";var d=core.material.icons.terrains[g];var e=core.material.images.terrains;for(var o=0;o<13;o++){for(var p=0;p<13;p++){core.canvas.bg.drawImage(e,0,d*32,32,32,o*32,p*32,32,32)}}if(core.isset(core.floors[k].png)){var o=0,p=0,n=416;var l=core.floors[k].png;var m=n/416;if(typeof l=="string"){if(core.isset(core.material.images.pngs[l])){core.canvas.bg.drawImage(core.material.images.pngs[l],o,p,n,n)}}else{if(l instanceof Array){l.forEach(function(u){if(u.length!=3){return}var b=parseInt(u[0]),q=parseInt(u[1]),s=u[2];if(core.isset(b)&&core.isset(q)&&core.isset(core.material.images.pngs[s])){b*=32;q*=32;var r=core.material.images.pngs[s];core.canvas.bg.drawImage(r,o+b*m,p+q*m,Math.min(n-b*m,m*r.width),Math.min(n-q*m,m*r.height))}})}}}var h=core.maps.getMapArray(i);for(var a=0;a<i.length;a++){var c=i[a];if(core.isset(c.event)&&!(core.isset(c.enable)&&!c.enable)){if(c.event.cls=="autotile"){core.drawAutotile(core.canvas.event,h,c,32,0,0)}else{if(c.event.id!="none"){d=core.material.icons[c.event.cls][c.event.id];e=core.material.images[c.event.cls];core.canvas.event.drawImage(core.material.images[c.event.cls],0,d*32,32,32,c.x*32,c.y*32,32,32);core.addGlobalAnimate(c.event.animate,c.x*32,c.y*32,d,e)}}}}core.setGlobalAnimate(core.values.animateSpeed);if(core.isset(f)){f()}};core.prototype.drawAutotile=function(c,n,a,p,m,q){var l=[[10,9,4,3],[10,9,4,13],[10,9,18,3],[10,9,16,15],[10,43,4,3],[10,31,4,25],[10,7,2,3],[10,31,16,5],[48,9,4,3],[8,9,4,1],[36,9,30,3],[36,9,6,15],[46,45,4,3],[46,11,4,25],[12,45,30,3],[34,33,28,27]];var d=function(t,u,v,i,w,x){var y=16*((w-1)%6),z=16*(~~((w-1)/6));t.drawImage(i,y,z,16,16,u,v,x/2,x/2)};var g=function(i,t,u){if(t<0||u<0||t>12||u>12){return 1}else{return n[u][t]==i?1:0}};var b=function(F,G){var v=n[G][F];var E=[];for(var w=0;w<4;w++){var u=0;var C=w%2,D=~~(w/2);for(var z=0;z<4;z++){var A=z%2,B=~~(z/2);var t=g(v,F+C+A-1,G+D+B-1);u+=t*(Math.pow(2,3-z))}E.push(u)}return E};var h=function(z,A){var v=[];var w=b(z,A);for(var u=0;u<4;u++){var t=l[w[u]];v.push(t[3-u])}return v};var r=a.x,s=a.y;var o=h(r,s);if(o[0]==13){if(o[1]==16){o[1]=14}if(o[2]==31){o[2]=19}}if(o[1]==18){if(o[0]==15){o[0]=17}if(o[3]==36){o[3]=24}}if(o[2]==43){if(o[0]==25){o[0]=37}if(o[3]==46){o[3]=44}}if(o[3]==48){if(o[1]==30){o[1]=42}if(o[2]==45){o[2]=47}}for(var j=0;j<4;j++){var k=o[j];var e=r*p+p/2*(j%2),f=s*p+p/2*(~~(j/2));d(c,e+m,f+q,core.material.images.autotile[a.event.id],k,p)}};core.prototype.noPassExists=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return core.isset(a.block.event.noPass)&&a.block.event.noPass};core.prototype.noPass=function(a,b){return a<0||a>12||b<0||b>12||core.noPassExists(a,b)};core.prototype.npcExists=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls=="npcs"};core.prototype.terrainExists=function(d,e,c,b){var a=core.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(core.isset(c)?a.block.event.id==c:true)};core.prototype.stairExists=function(c,d,b){var a=core.getBlock(c,d,b);if(a==null){return false}return a.block.event.cls=="terrains"&&(a.block.event.id=="upFloor"||a.block.event.id=="downFloor")};core.prototype.nearStair=function(){var a=core.getHeroLoc("x"),b=core.getHeroLoc("y");return core.stairExists(a,b)||core.stairExists(a-1,b)||core.stairExists(a,b-1)||core.stairExists(a+1,b)||core.stairExists(a,b+1)};core.prototype.enemyExists=function(d,e,c,b){var a=core.getBlock(d,e,b);if(a==null){return false}return a.block.event.cls=="enemys"&&(core.isset(c)?a.block.event.id==c:true)};core.prototype.getBlock=function(e,f,b,d){if(!core.isset(b)){b=core.status.floorId}if(!core.isset(d)){d=true}var a=core.status.maps[b].blocks;for(var c=0;c<a.length;c++){if(a[c].x==e&&a[c].y==f&&core.isset(a[c].event)){if(d&&core.isset(a[c].enable)&&!a[c].enable){return null}return{index:c,block:a[c]}}}return null};core.prototype.moveBlock=function(p,q,n,o,g,f){o=o||500;core.status.replay.animate=true;core.saveCanvas("animate");core.clearMap("animate",0,0,416,416);var e=core.getBlock(p,q,core.status.floorId,false);if(e==null){if(core.isset(f)){f()}return}core.removeBlock(p,q);core.clearMap("ui",0,0,416,416);core.setAlpha("ui",1);e=e.block;blockIcon=core.material.icons[e.event.cls][e.event.id];blockImage=core.material.images[e.event.cls];var k=1;core.setOpacity("animate",k);core.canvas.animate.drawImage(blockImage,0,blockIcon*32,32,32,e.x*32,e.y*32,32,32);var h=[];n.forEach(function(r){if(typeof r=="string"){h.push(r)}else{if(!core.isset(r.value)){h.push(r.direction)}else{for(var s=0;s<r.value;s++){h.push(r.direction)}}}});var i=32*p,j=32*q,m=0;var l={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};var d=e.event.animate||1;var b=0;var c=0;var a=window.setInterval(function(){c+=o/16/core.status.replay.speed;if(c>=core.values.animateSpeed*2/d){b++;c=0;if(b>=d){b=0}}if(h.length==0){if(g){k=0}else{k-=0.06}core.setOpacity("animate",k);core.clearMap("animate",i,j,32,32);core.canvas.animate.drawImage(blockImage,b*32,blockIcon*32,32,32,i,j,32,32);if(k<=0){clearInterval(a);core.loadCanvas("animate");core.clearMap("animate",0,0,416,416);core.setOpacity("animate",1);core.status.replay.animate=false;if(core.isset(f)){f()}}}else{m++;i+=l[h[0]].x*2;j+=l[h[0]].y*2;core.clearMap("animate",i-32,j-32,96,96);core.canvas.animate.drawImage(blockImage,b*32,blockIcon*32,32,32,i,j,32,32);if(m==16){m=0;h.shift()}}},o/16/core.status.replay.speed)};core.prototype.animateBlock=function(e,h,g,b){if(h!="hide"){h="show"}core.status.replay.animate=true;core.saveCanvas("animate");core.clearMap("animate",0,0,416,416);if(typeof e[0]=="number"&&typeof e[1]=="number"){e=[e]}var d=[];e.forEach(function(j){var i=core.getBlock(j[0],j[1],core.status.floorId,false);if(i==null){return}i=i.block;d.push({x:j[0],y:j[1],blockIcon:core.material.icons[i.event.cls][i.event.id],blockImage:core.material.images[i.event.cls]})});if(d.length==0){if(core.isset(b)){b()}return}var c=function(){d.forEach(function(i){core.canvas.animate.drawImage(i.blockImage,0,i.blockIcon*32,32,32,i.x*32,i.y*32,32,32)})};var f=0;if(h=="hide"){f=1}core.setOpacity("animate",f);c();var a=window.setInterval(function(){if(h=="show"){f+=0.1}else{f-=0.1}core.setOpacity("animate",f);core.clearMap("animate",0,0,416,416);c();if(f>=1||f<=0){clearInterval(a);core.loadCanvas("animate");core.clearMap("animate",0,0,416,416);core.setOpacity("animate",1);core.status.replay.animate=false;if(core.isset(b)){b()}}},g/10/core.status.replay.speed)};core.prototype.showBlock=function(c,d,b){b=b||core.status.floorId;var a=core.getBlock(c,d,b,false);if(a==null){return}a=a.block;if(core.isset(a.enable)&&!a.enable){a.enable=true;if(b==core.status.floorId&&core.isset(a.event)){blockIcon=core.material.icons[a.event.cls][a.event.id];blockImage=core.material.images[a.event.cls];core.canvas.event.drawImage(core.material.images[a.event.cls],0,blockIcon*32,32,32,a.x*32,a.y*32,32,32);core.addGlobalAnimate(a.event.animate,a.x*32,a.y*32,blockIcon,blockImage);core.syncGlobalAnimate()}core.updateStatusBar()}};core.prototype.removeBlock=function(d,e,b){b=b||core.status.floorId;var a=core.getBlock(d,e,b,false);if(a==null){return}var c=a.index;if(b==core.status.floorId){core.removeGlobalAnimate(d,e);core.canvas.event.clearRect(d*32,e*32,32,32)}core.removeBlockById(c,b);core.updateFg()};core.prototype.removeBlockById=function(d,c){var a=core.status.maps[c].blocks;var e=a[d].x,f=a[d].y;var b=core.floors[c].events[e+","+f];if(!core.isset(b)){b=core.floors[c].changeFloor[e+","+f]}if(!core.isset(b)){a.splice(d,1);return}a[d].enable=false};core.prototype.removeBlockByIds=function(a,b){b.sort(function(c,d){return d-c}).forEach(function(c){core.removeBlockById(c,a)})};core.prototype.addGlobalAnimate=function(a,d,e,c,b){if(a==2){core.status.twoAnimateObjs.push({x:d,y:e,status:0,loc:c,image:b})}else{if(a==4){core.status.fourAnimateObjs.push({x:d,y:e,status:0,loc:c,image:b})}}};core.prototype.removeGlobalAnimate=function(d,e,a){if(a==true){core.status.twoAnimateObjs=[];core.status.fourAnimateObjs=[]}for(var c=0;c<core.status.twoAnimateObjs.length;c++){if(core.status.twoAnimateObjs[c].x==d*32&&core.status.twoAnimateObjs[c].y==e*32){core.status.twoAnimateObjs.splice(c,1);return}}for(var b=0;b<core.status.fourAnimateObjs.length;b++){if(core.status.fourAnimateObjs[b].x==d*32&&core.status.fourAnimateObjs[b].y==e*32){core.status.fourAnimateObjs.splice(b,1);return}}};core.prototype.setGlobalAnimate=function(a){core.syncGlobalAnimate();core.animateFrame.speed=a;core.animateFrame.globalAnimate=true};core.prototype.syncGlobalAnimate=function(){core.status.twoAnimateObjs.forEach(function(a){a.status=0});core.status.fourAnimateObjs.forEach(function(a){a.status=0})};core.prototype.drawBoxAnimate=function(){for(var b=0;b<core.status.boxAnimateObjs.length;b++){var c=core.status.boxAnimateObjs[b];c.status=((c.status||0)+1)%2;core.clearMap("ui",c.bgx,c.bgy,c.bgsize,c.bgsize);core.fillRect("ui",c.bgx,c.bgy,c.bgsize,c.bgsize,core.animateFrame.background);core.canvas.ui.drawImage(c.image,c.status*32,c.icon*32,32,32,c.x,c.y,32,32)}};core.prototype.drawAnimate=function(g,i,j,b){if(core.isset(core.status.replay)&&core.status.replay.replaying){if(core.isset(b)){b()}return}if(!core.isset(core.material.animates[g])||!core.isset(i)||!core.isset(j)){if(core.isset(b)){b()}return}clearInterval(core.interval.animateInterval);core.clearMap("animate",0,0,416,416);var a=core.material.animates[g];var h=a.ratio;var c=32*i+16,d=32*j+16;var f=0;var e=function(l){core.clearMap("animate",0,0,416,416);var k=a.frames[l];k.forEach(function(r){var o=a.images[r.index];if(!core.isset(o)){return}var q=o.width*h*r.zoom/100;var p=o.height*h*r.zoom/100;core.setAlpha("animate",r.opacity/255);var m=c+r.x,n=d+r.y;if(!r.mirror&&!r.angle){core.canvas.animate.drawImage(o,m-q/2,n-p/2,q,p)}else{core.saveCanvas("animate");core.canvas.animate.translate(m,n);if(r.angle){core.canvas.animate.rotate(-r.angle*Math.PI/180)}if(r.mirror){core.canvas.animate.scale(-1,1)}core.canvas.animate.drawImage(o,-q/2,-p/2,q,p);core.loadCanvas("animate")}})};e(f++);core.interval.animateInterval=setInterval(function(k){if(f==a.frames.length){clearInterval(core.interval.animateInterval);core.clearMap("animate",0,0,416,416);core.setAlpha("animate",1);if(core.isset(b)){b()}return}e(f++)},50)};core.prototype.updateCheckBlock=function(){core.status.checkBlock={};if(!core.isset(core.status.thisMap)){return}var b=core.status.thisMap.blocks;core.status.checkBlock.map=[];for(var k=0;k<b.length;k++){var a=b[k];if(core.isset(a.event)&&!(core.isset(a.enable)&&!a.enable)&&a.event.cls=="enemys"){var g=a.event.id,e=core.enemys.getEnemys(g);if(core.isset(e)){core.status.checkBlock.map[13*a.x+a.y]=g}}}core.status.checkBlock.damage=[];for(var p=0;p<13*13;p++){core.status.checkBlock.damage[p]=0}for(var p=0;p<13;p++){for(var q=0;q<13;q++){var g=core.status.checkBlock.map[13*p+q];if(core.isset(g)){var e=core.enemys.getEnemys(g);if(core.enemys.hasSpecial(e.special,15)){var o=e.range||1;var r=false;if(core.isset(e.zoneSquare)){r=e.zoneSquare}for(var c=-o;c<=o;c++){for(var d=-o;d<=o;d++){if(c==0&&d==0){continue}var l=p+c,m=q+d;if(l<0||l>12||m<0||m>12){continue}if(!r&&Math.abs(c)+Math.abs(d)>o){continue}core.status.checkBlock.damage[13*l+m]+=e.value}}}if(core.enemys.hasSpecial(e.special,18)){for(var c=-1;c<=1;c++){for(var d=-1;d<=1;d++){if(c==0&&d==0){continue}var l=p+c,m=q+d;if(l<0||l>12||m<0||m>12||Math.abs(c)+Math.abs(d)>1){continue}core.status.checkBlock.damage[13*l+m]+=e.value}}}}}}core.status.checkBlock.betweenAttack=[];for(var p=0;p<13;p++){for(var q=0;q<13;q++){var f=false;if(p>0&&p<12){var h=core.status.checkBlock.map[13*(p-1)+q],i=core.status.checkBlock.map[13*(p+1)+q];if(core.isset(h)&&core.isset(i)&&h==i){var e=core.enemys.getEnemys(h);if(core.enemys.hasSpecial(e.special,16)){f=true}}}if(q>0&&q<12){var h=core.status.checkBlock.map[13*p+q-1],i=core.status.checkBlock.map[13*p+q+1];if(core.isset(h)&&core.isset(i)&&h==i){var e=core.enemys.getEnemys(h);if(core.enemys.hasSpecial(e.special,16)){f=true}}}if(f){core.status.checkBlock.betweenAttack[13*p+q]=true;var j=core.status.hero.hp-core.status.checkBlock.damage[13*p+q];if(j>1){core.status.checkBlock.damage[13*p+q]+=parseInt((j+(core.flags.betweenAttackCeil?0:1))/2)}}}}};core.prototype.checkBlock=function(){var i=core.getHeroLoc("x"),j=core.getHeroLoc("y");var a=core.status.checkBlock.damage[13*i+j];if(a>0){core.status.hero.hp-=a;var h=[];var g={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};for(var b in g){var e=i+g[b].x,f=j+g[b].y;if(e<0||e>12||f<0||f>12){continue}var d=core.status.checkBlock.map[13*e+f];if(core.isset(d)){var c=core.enemys.getEnemys(d);if(core.isset(c)&&core.enemys.hasSpecial(c.special,18)){h.push({direction:b,x:e,y:f})}}}if(core.status.checkBlock.betweenAttack[13*i+j]&&a>0){core.drawTip("受到夹击，生命变成一半")}else{if(h.length>0&&a>0){core.drawTip("受到阻击伤害"+a+"点")}else{if(a>0){core.drawTip("受到领域伤害"+a+"点")}}}core.playSound("zone.ogg");core.drawAnimate("zone",i,j);if(core.status.hero.hp<=0){core.status.hero.hp=0;core.updateStatusBar();core.events.lose("zone");return}h=h.filter(function(n){var o=n.x,p=n.y,k=n.direction;var l=o+g[k].x,m=p+g[k].y;return l>=0&&l<=12&&m>=0&&m<=12&&core.getBlock(l,m,core.status.floorId,false)==null});core.updateStatusBar();if(h.length>0){core.snipe(h)}}};core.prototype.snipe=function(c){var b={up:{x:0,y:-1},left:{x:-1,y:0},down:{x:0,y:1},right:{x:1,y:0}};c.forEach(function(h){var i=h.x,j=h.y,g=h.direction;h.nx=i+b[h.direction].x;h.ny=j+b[h.direction].y;core.removeGlobalAnimate(i,j);var d=core.getBlock(i,j).block;h.blockIcon=core.material.icons[d.event.cls][d.event.id];h.blockImage=core.material.images[d.event.cls];var f=core.enemys.getDamage(d.event.id);var e="#000000";if(f<=0){e="#00FF00"}else{if(f<core.status.hero.hp/3){e="#FFFFFF"}else{if(f<core.status.hero.hp*2/3){e="#FFFF00"}else{if(f<core.status.hero.hp){e="#FF7F00"}else{e="#FF0000"}}}}if(f>=999999999){f="???"}else{if(f>100000){f=(f/10000).toFixed(1)+"w"}}h.damage=f;h.color=e;h.block=core.clone(d)});var a=function(){c.forEach(function(e){core.removeBlock(e.x,e.y);var d=core.clone(e.block);d.x=e.nx;d.y=e.ny;core.status.thisMap.blocks.push(d);core.addGlobalAnimate(2,32*e.nx,32*e.ny,e.blockIcon,e.blockImage);core.canvas.event.drawImage(e.blockImage,0,e.blockIcon*32,32,32,32*e.nx,32*e.ny,32,32)});core.syncGlobalAnimate();core.updateStatusBar();return};if(core.status.replay.replaying){a()}else{core.waitHeroToStop(function(){core.lockControl();var i=500,h=0;var g=2;var e=0;var f=0;core.canvas.fg.textAlign="left";var d=window.setInterval(function(){h++;f+=i/16;if(f>=core.values.animateSpeed*2/g){e++;f=0;if(e>=g){e=0}}c.forEach(function(m){var n=m.x,o=m.y,j=m.direction;var k=32*n+b[j].x*2*h,l=32*o+b[j].y*2*h;core.clearMap("event",k-2*b[j].x,l-2*b[j].y,32,32);core.clearMap("fg",k-2*b[j].x,l-2*b[j].y,32,32);core.canvas.event.drawImage(m.blockImage,e*32,m.blockIcon*32,32,32,k,l,32,32);if(core.hasItem("book")){core.setFillStyle("fg","#000000");core.canvas.fg.fillText(m.damage,k+2,l+30);core.canvas.fg.fillText(m.damage,k,l+30);core.canvas.fg.fillText(m.damage,k+2,l+32);core.canvas.fg.fillText(m.damage,k,l+32);core.setFillStyle("fg",m.color);core.canvas.fg.fillText(m.damage,k+1,l+31)}});if(h==16){clearInterval(d);a();if(core.status.event.id==null){core.unLockControl()}}},i/16)})}};core.prototype.setWeather=function(d,c){if(d!="rain"&&d!="snow"){core.clearMap("weather",0,0,416,416);core.animateFrame.weather.type=null;core.animateFrame.weather.level=0;core.animateFrame.weather.nodes=[];return}c=parseInt(c);if(d==core.animateFrame.weather.type&&(!core.isset(c)||20*c==core.animateFrame.weather.level)){return}if(!core.isset(c)){c=5}if(c<1){c=1}if(c>10){c=10}c*=20;core.clearMap("weather",0,0,416,416);core.animateFrame.weather.type=d;core.animateFrame.weather.level=c;core.animateFrame.weather.nodes=[];if(d=="rain"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,l:Math.random()*2.5,xs:-4+Math.random()*4+2,ys:Math.random()*10+10})}}else{if(d=="snow"){for(var b=0;b<c;b++){core.animateFrame.weather.nodes.push({x:Math.random()*416,y:Math.random()*416,r:Math.random()*5+1,d:Math.random()*c,})}}}};core.prototype.setFg=function(c,f,a){if(!core.isset(f)){f=750}if(f<=0){f=0}if(!core.isset(core.status.curtainColor)){core.status.curtainColor=[0,0,0,0]}var d=core.status.curtainColor;if(!core.isset(c)){c=[0,0,0,0]}if(c.length==3){c.push(1)}if(c[3]<0){c[3]=0}if(c[3]>1){c[3]=1}if(f==0){core.dom.curtain.style.background=core.arrayToRGB(c);core.dom.curtain.style.opacity=c[3];core.status.curtainColor=c;if(core.isset(a)){a()}return}var e=0;core.status.replay.animate=true;var b=setInterval(function(){e++;var g=d[3]+(c[3]-d[3])*e/25;var j=parseInt(d[0]+(c[0]-d[0])*e/25);var i=parseInt(d[1]+(c[1]-d[1])*e/25);var h=parseInt(d[2]+(c[2]-d[2])*e/25);core.dom.curtain.style.background=core.arrayToRGB([j,i,h]);core.dom.curtain.style.opacity=g;if(e>=25){clearInterval(b);core.status.curtainColor=c;core.status.replay.animate=false;if(core.isset(a)){a()}}},f/25)};core.prototype.updateFg=function(){if(!core.isset(core.status.thisMap)||!core.isset(core.status.thisMap.blocks)){return}var h=core.status.thisMap.blocks;core.clearMap("fg",0,0,416,416);if(!core.hasItem("book")){return}core.setFont("fg","bold 11px Arial");var f=core.status.hero.hp;if(core.flags.displayEnemyDamage){core.canvas.fg.textAlign="left";for(var a=0;a<h.length;a++){var i=h[a].x,j=h[a].y;if(core.isset(h[a].event)&&h[a].event.cls=="enemys"&&!(core.isset(h[a].enable)&&!h[a].enable)){if(h[a].event.trigger!="battle"){var e=core.floors[core.status.floorId].events[i+","+j];if(core.isset(e)&&!(e instanceof Array)){if(core.isset(e.displayDamage)&&!e.displayDamage){continue}}}var g=h[a].event.id;var d=core.enemys.getDamage(g);var c="#000000";if(d<=0){c="#00FF00"}else{if(d<f/3){c="#FFFFFF"}else{if(d<f*2/3){c="#FFFF00"}else{if(d<f){c="#FF7F00"}else{c="#FF0000"}}}}if(d>=999999999){d="???"}else{if(d>100000){d=(d/10000).toFixed(1)+"w"}}core.setFillStyle("fg","#000000");core.canvas.fg.fillText(d,32*i+2,32*(j+1)-2);core.canvas.fg.fillText(d,32*i,32*(j+1)-2);core.canvas.fg.fillText(d,32*i+2,32*(j+1));core.canvas.fg.fillText(d,32*i,32*(j+1));core.setFillStyle("fg",c);core.canvas.fg.fillText(d,32*i+1,32*(j+1)-1)}}}if(core.flags.displayExtraDamage){core.canvas.fg.textAlign="center";for(var i=0;i<13;i++){for(var j=0;j<13;j++){var d=core.status.checkBlock.damage[13*i+j];if(d>0){core.setFillStyle("fg","#000000");core.canvas.fg.fillText(d,32*i+17,32*(j+1)-13);core.canvas.fg.fillText(d,32*i+15,32*(j+1)-15);core.canvas.fg.fillText(d,32*i+17,32*(j+1)-15);core.canvas.fg.fillText(d,32*i+15,32*(j+1)-13);core.setFillStyle("fg","#FF7F00");core.canvas.fg.fillText(d,32*i+16,32*(j+1)-14)}}}}};core.prototype.itemCount=function(b){if(!core.isset(b)||!core.isset(core.material.items[b])){return 0}var a=core.material.items[b].cls;if(a=="items"){return 0}return core.isset(core.status.hero.items[a][b])?core.status.hero.items[a][b]:0};core.prototype.hasItem=function(a){return core.itemCount(a)>0};core.prototype.setItem=function(b,c){var a=core.material.items[b].cls;if(a=="items"){return}if(!core.isset(core.status.hero.items[a])){core.status.hero.items[a]={}}core.status.hero.items[a][b]=c;if(a!="keys"&&c==0){delete core.status.hero.items[a][b]}};core.prototype.removeItem=function(b){if(!core.hasItem(b)){return false}var a=core.material.items[b].cls;core.status.hero.items[a][b]--;if(a!="keys"&&core.status.hero.items[a][b]==0){delete core.status.hero.items[a][b]}core.updateStatusBar();return true};core.prototype.useItem=function(b,a){core.items.useItem(b,a);return};core.prototype.canUseItem=function(a){return core.items.canUseItem(a)};core.prototype.addItem=function(c,d){var b=core.material.items[c];var a=b.cls;if(a=="items"){return}if(!core.isset(core.status.hero.items[a])){core.status.hero.items[a]={};core.status.hero.items[a][c]=0}else{if(!core.isset(core.status.hero.items[a][c])){core.status.hero.items[a][c]=0}}core.status.hero.items[a][c]+=d};core.prototype.getNextItem=function(){if(!core.status.heroStop||!core.flags.enableGentleClick){return}var b=core.nextX(),c=core.nextY();var a=core.getBlock(b,c);if(a==null){return}if(a.block.event.trigger=="getItem"){core.getItem(a.block.event.id,1,b,c);core.status.route.push("getNext")}};core.prototype.getItem=function(d,e,f,g,a){core.playSound("item.ogg");var c=core.material.items[d].cls;core.items.getItemEffect(d,e);core.removeBlock(f,g);var h="获得 "+core.material.items[d].name;if(e>1){h+="x"+e}if(c==="items"){h+=core.items.getItemEffectTip(d)}core.drawTip(h,core.material.icons.items[d]);core.canvas.event.clearRect(f*32,g*32,32,32);core.updateStatusBar();var b=core.floors[core.status.floorId].afterGetItem[f+","+g];if(core.isset(b)){core.events.doEvents(b,f,g,a)}else{if(core.isset(a)){a()}}};core.prototype.drawTip=function(e,c){var f,g,h,a,b=false,d=0;clearInterval(core.interval.tipAnimate);core.setFont("data","16px Arial");core.saveCanvas("data");core.setOpacity("data",0);core.canvas.data.textAlign="left";if(!core.isset(c)){f=16;g=18;h=f+core.canvas.data.measureText(e).width+16;a=42}else{f=44;g=18;h=f+core.canvas.data.measureText(e).width+8;a=42}core.interval.tipAnimate=window.setInterval(function(){if(b){d-=0.1}else{d+=0.1}core.setOpacity("data",d);core.clearMap("data",5,5,400,a);core.fillRect("data",5,5,h,a,"#000");if(core.isset(c)){core.canvas.data.drawImage(core.material.images.items,0,c*32,32,32,10,8,32,32)}core.fillText("data",e,f+5,g+15,"#fff");if(d>0.6||d<0){if(b){core.loadCanvas("data");core.clearMap("data",5,5,400,a);core.setOpacity("data",1);clearInterval(core.interval.tipAnimate);return}else{if(!core.isset(core.timeout.getItemTipTimeout)){core.timeout.getItemTipTimeout=window.setTimeout(function(){b=true;core.timeout.getItemTipTimeout=null},750)}d=0.6;core.setOpacity("data",d)}}},30)};core.prototype.drawText=function(b,a){if(core.isset(b)){if(core.isset(core.status.event)&&core.status.event.id=="action"){core.insertAction(b,null,null,a);return}if(typeof b=="string"){b=[{content:b}]}else{if(b instanceof Object&&core.isset(b.content)){b=[b]}else{if(!(b instanceof Array)){core.drawTip("出错了");console.log(b);return}}}core.status.event={id:"text",data:{list:b,callback:a}};core.lockControl();core.stopAutomaticRoute();setTimeout(function(){core.drawText()},30);return}if(core.status.event.data.list.length==0){var a=core.status.event.data.callback;core.ui.closePanel(false);if(core.isset(a)){a()}return}var c=core.status.event.data.list.shift();if(typeof c=="string"){core.ui.drawTextBox(c)}else{core.ui.drawTextBox(c.content,c.id)}};core.prototype.replaceText=function(a){return a.replace(/\${([^}]+)}/g,function(c,b){return core.calValue(b)})};core.prototype.calValue=function(value){value=value.replace(/status:([\w\d_]+)/g,"core.getStatus('$1')");value=value.replace(/item:([\w\d_]+)/g,"core.itemCount('$1')");value=value.replace(/flag:([\w\d_]+)/g,"core.getFlag('$1', false)");return eval(value)};core.prototype.doEffect=function(b){var a=b.split("+=");if(a.length!=2){return}var d=a[0],f=core.calValue(a[1]);if(d.indexOf("status:")==0){var e=d.substring(7);core.setStatus(e,core.getStatus(e)+f)}else{if(d.indexOf("item:")==0){var c=d.substring(5);core.setItem(c,core.itemCount(c)+f)}}};core.prototype.splitLines=function(a,g,f,c){if(core.isset(c)){core.setFont(a,c)}var b=[];var e=0;for(var d=0;d<g.length;d++){if(g.charAt(d)=="\n"){b.push(g.substring(e,d));e=d+1}else{if(g.charAt(d)=="\\"&&g.charAt(d+1)=="n"){b.push(g.substring(e,d));e=d+2}else{var h=g.substring(e,d+1);var j=core.canvas[a].measureText(h).width;if(j>f){b.push(g.substring(e,d));e=d}}}}b.push(g.substring(e));return b};core.prototype.unshift=function(c,d){if(!(c instanceof Array)||!core.isset(d)){return}if(d instanceof Array){core.clone(d).reverse().forEach(function(a){c.unshift(a)})}else{c.unshift(d)}return c};core.prototype.setLocalStorage=function(b,c){try{localStorage.setItem(core.firstData.name+"_"+b,JSON.stringify(c));return true}catch(a){console.log(a);return false}};core.prototype.getLocalStorage=function(b,a){var c=localStorage.getItem(core.firstData.name+"_"+b);if(core.isset(c)){return JSON.parse(c)}return a};core.prototype.removeLocalStorage=function(a){localStorage.removeItem(core.firstData.name+"_"+a)};core.prototype.clone=function(b){if(!core.isset(b)){return b}if(b instanceof Date){var a=new Date();a.setTime(b.getTime());return a}if(b instanceof Array){var a=[];for(var c in b){a[c]=core.clone(b[c])}return a}if(b instanceof Function){return b}if(b instanceof Object){var a={};for(var c in b){if(b.hasOwnProperty(c)){a[c]=core.clone(b[c])}}return a}return b};core.prototype.formatDate=function(a){if(!core.isset(a)){return""}return a.getFullYear()+"-"+core.setTwoDigits(a.getMonth()+1)+"-"+core.setTwoDigits(a.getDate())+" "+core.setTwoDigits(a.getHours())+":"+core.setTwoDigits(a.getMinutes())+":"+core.setTwoDigits(a.getSeconds())};core.prototype.formatDate2=function(a){if(!core.isset(a)){return""}return a.getFullYear()+core.setTwoDigits(a.getMonth()+1)+core.setTwoDigits(a.getDate())+core.setTwoDigits(a.getHours())+core.setTwoDigits(a.getMinutes())+core.setTwoDigits(a.getSeconds())};core.prototype.setTwoDigits=function(a){return parseInt(a)<10?"0"+a:a};core.prototype.arrayToRGB=function(a){var d=parseInt(a[0])||0,c=parseInt(a[1])||0,b=parseInt(a[2])||0;if(d<0){d=0}if(b<0){b=0}if(c<0){c=0}if(d>255){d=255}if(b>255){b=255}if(c>255){c=255}return"#"+((1<<24)+(d<<16)+(c<<8)+b).toString(16).slice(1)};core.prototype.debug=function(){core.setStatus("hp",999999);core.setStatus("atk",10000);core.setStatus("def",10000);core.setStatus("mdef",10000);core.setStatus("money",10000);core.setStatus("experience",10000);core.setItem("yellowKey",50);core.setItem("blueKey",50);core.setItem("redKey",50);core.setItem("book",1);core.setItem("fly",1);for(var a in core.status.maps){if(core.status.maps[a].canFlyTo&&core.status.hero.flyRange.indexOf(a)<0){core.status.hero.flyRange.push(a)}}core.updateStatusBar();core.drawTip("作弊成功")};core.prototype.startReplay=function(a){core.status.replay.replaying=true;core.status.replay.pausing=false;core.status.replay.speed=1;core.status.replay.toReplay=core.clone(a);core.status.replay.totalList=core.clone(a);core.updateStatusBar();core.drawTip("开始播放");this.replay();return};core.prototype.triggerReplay=function(){if(core.status.replay.pausing){this.resumeReplay()}else{this.pauseReplay()}};core.prototype.pauseReplay=function(){if(!core.status.replay.replaying){return}core.status.replay.pausing=true;core.updateStatusBar();core.drawTip("暂停播放")};core.prototype.resumeReplay=function(){if(!core.status.replay.replaying){return}core.status.replay.pausing=false;core.updateStatusBar();core.drawTip("恢复播放");core.replay()};core.prototype.forwardReplay=function(){if(!core.status.replay.replaying){return}core.status.replay.speed=parseInt(10*core.status.replay.speed+1)/10;if(core.status.replay.speed>2.5){core.status.replay.speed=2.5}core.drawTip("x"+core.status.replay.speed+"倍")};core.prototype.rewindReplay=function(){if(!core.status.replay.replaying){return}core.status.replay.speed=parseInt(10*core.status.replay.speed-1)/10;if(core.status.replay.speed<0.3){core.status.replay.speed=0.3}core.drawTip("x"+core.status.replay.speed+"倍")};core.prototype.stopReplay=function(){if(!core.status.replay.replaying){return}core.status.replay.toReplay=[];core.status.replay.totalList=[];core.status.replay.replaying=false;core.status.replay.pausing=false;core.status.replay.speed=1;core.updateStatusBar();core.drawTip("停止播放并恢复游戏")};core.prototype.replay=function(){if(!core.status.replay.replaying){return}if(core.status.replay.pausing){return}if(core.status.replay.animate){return}if(core.status.replay.toReplay.length==0){core.stopReplay();core.insertAction("录像回放完毕！");return}var a=core.status.replay.toReplay.shift();if(a=="up"||a=="down"||a=="left"||a=="right"){core.moveHero(a,function(){core.replay()});return}else{if(a.indexOf("item:")==0){var g=a.substring(5);if(core.canUseItem(g)){var r=Object.keys(core.status.hero.items.tools).sort();var d=Object.keys(core.status.hero.items.constants).sort();var f;if((f=r.indexOf(g))>=0||(f=d.indexOf(g)+100)>=100){core.ui.drawToolbox(f);setTimeout(function(){core.ui.closePanel();core.useItem(g,function(){core.replay()})},750)}return}}else{if(a.indexOf("fly:")==0){var e=a.substring(4);var q=core.status.hero.flyRange.indexOf(e);var j=core.status.hero.flyRange.indexOf(core.status.floorId);if(core.hasItem("fly")&&q>=0&&j>=0){core.ui.drawFly(q);setTimeout(function(){core.ui.closePanel();var v=q<j?"upFloor":"downFloor";core.status.route.push("fly:"+e);core.changeFloor(e,v,null,null,function(){core.replay()})},750);return}}else{if(a.indexOf("shop:")==0){var p=a.substring(5).split(":");var n=p[0],l=p[1].split("");if(l.length>0){var m=core.status.shops[n];if(core.isset(m)&&m.visited){var c=m.choices;var s=6-parseInt(c.length/2);core.status.event.selection=parseInt(l.shift());core.events.openShop(n,false);var o=setInterval(function(){if(!core.events.clickShop(6,s+core.status.event.selection)){clearInterval(o);core.stopReplay();core.drawTip("录像文件出错");return}if(l.length==0){clearInterval(o);core.events.clickShop(6,s+c.length);core.replay();return}core.status.event.selection=parseInt(l.shift());core.events.openShop(n,false)},750);return}}}else{if(a=="turn"){core.turnHero();core.replay();return}else{if(a=="getNext"){if(core.flags.enableGentleClick&&core.getBlock(core.nextX(),core.nextY())!=null){var h=core.nextX(),i=core.nextY();var b=core.getBlock(h,i);if(b!=null&&b.block.event.trigger=="getItem"){core.getItem(b.block.event.id,1,h,i);core.status.route.push("getNext");core.replay();return}}}else{if(a.indexOf("move:")==0){var k=a.substring(5).split(":");var t=parseInt(k[0]),u=parseInt(k[1]);if(core.canMoveDirectly(t,u)){core.clearMap("hero",0,0,416,416);core.setHeroLoc("x",t);core.setHeroLoc("y",u);core.drawHero(core.getHeroLoc("direction"),core.getHeroLoc("x"),core.getHeroLoc("y"),"stop");core.status.route.push("move:"+t+":"+u);core.replay();return}}}}}}}}core.stopReplay();core.insertAction("录像文件出错")};core.prototype.checkStatus=function(b,c,a){if(c&&core.status.event.id==b){core.ui.closePanel();return false}if(c&&core.status.lockControl){return false}if(core.isset(a)&&a&&!core.hasItem(b)){core.drawTip("你没有"+core.material.items[b].name);return false}if(!core.status.heroStop){core.drawTip("请先停止勇士行动");return false}core.lockControl();core.status.event.id=b;return true};core.prototype.openBook=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(core.status.event.id=="book"&&core.isset(core.status.event.selection)){core.status.boxAnimateObjs=[];core.ui.drawMaps(core.status.event.selection);return}if(core.status.event.id=="viewMaps"){a=false;core.status.event.selection=core.status.event.data}if(!core.checkStatus("book",a,true)){return}core.useItem("book")};core.prototype.useFly=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("fly",a,true)){return}if(core.flags.flyNearStair&&!core.nearStair()){core.drawTip("只有在楼梯边才能使用传送器");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}if(!core.canUseItem("fly")){core.drawTip("楼层传送器好像失效了");core.unLockControl();core.status.event.data=null;core.status.event.id=null;return}core.useItem("fly");return};core.prototype.openToolbox=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("toolbox",a)){return}core.ui.drawToolbox()};core.prototype.openQuickShop=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("selectShop",a)){return}core.ui.drawQuickShop()};core.prototype.save=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("save",a)){return}var d=core.status.saveIndex;var c=parseInt((d-1)/5),b=d-5*c;core.ui.drawSLPanel(10*c+b)};core.prototype.load=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}var d=core.getLocalStorage("saveIndex2",1);var c=parseInt((d-1)/5),b=d-5*c;if(!core.isPlaying()){core.status.event={id:"load",data:null};core.status.lockControl=true;core.dom.startPanel.style.display="none";core.ui.drawSLPanel(10*c+b);return}if(!core.checkStatus("load",a)){return}core.ui.drawSLPanel(10*c+b)};core.prototype.openSettings=function(a){if(core.isset(core.status.replay)&&core.status.replay.replaying){return}if(!core.checkStatus("settings",a)){return}core.ui.drawSettings()};core.prototype.autosave=function(a){var b=null;if(a){b=core.status.route.pop()}core.saveData("autoSave");if(a&&core.isset(b)){core.status.route.push(b)}};core.prototype.doSL=function(b,c){if(c=="save"){if(b=="autoSave"){core.drawTip("不能覆盖自动存档！");return}if(core.saveData("save"+b)){core.ui.closePanel();core.drawTip("存档成功！");if(b!="autoSave"){core.status.saveIndex=b;core.setLocalStorage("saveIndex2",core.status.saveIndex)}}else{core.drawTip("存储空间不足，请覆盖已有的存档或在菜单栏中进行清理")}return}else{if(c=="load"){var a=core.getLocalStorage(b=="autoSave"?b:"save"+b,null);if(!core.isset(a)){core.drawTip("无效的存档");return}if(a.version!=core.firstData.version){if(confirm("存档版本不匹配！\n你想回放此存档的录像吗？")){core.dom.startPanel.style.display="none";core.resetStatus(core.firstData.hero,a.hard,core.firstData.floorId,null,core.initStatus.maps);core.events.setInitData(a.hard);core.changeFloor(core.status.floorId,null,core.firstData.hero.loc,null,function(){core.startReplay(core.decodeRoute(a.route))})}return}core.ui.closePanel();core.loadData(a,function(){core.drawTip("读档成功");if(b!="autoSave"){core.status.saveIndex=b;core.setLocalStorage("saveIndex2",core.status.saveIndex)}});return}}};core.prototype.syncSave=function(f){var e=null;if(f=="all"){e=[];for(var c=1;c<=150;c++){var a=core.getLocalStorage("save"+c,null);if(core.isset(a)){e.push(a)}}}else{for(var c=150;c>=1;c--){e=core.getLocalStorage("save"+c,null);if(core.isset(e)){break}}}if(!core.isset(e)){core.drawText("没有要同步的存档");return}core.ui.drawWaiting("正在同步，请稍后...");var b=new FormData();b.append("type","save");b.append("name",core.firstData.name);var d=JSON.stringify(e);b.append("data",d);var g=new XMLHttpRequest();g.open("POST","/games/sync.php");g.onload=function(h){if(g.status==200){var i=JSON.parse(g.response);if(i.code<0){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因："+i.msg)}else{core.drawText("同步成功！\n\n您的存档编号： "+i.code+"\n您的存档密码： "+i.msg+"\n\n请牢记以上两个信息（如截图等），在从服务器\n同步存档时使用。")}}else{core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因：HTTP "+g.status)}};g.ontimeout=function(){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因：Timeout")};g.onerror=function(){core.drawText("出错啦！\n无法同步存档到服务器。\n错误原因：XHR Error")};g.send(b)};core.prototype.syncLoad=function(){var b=prompt("请输入存档编号：");if(b==null||b==""){core.ui.drawSyncSave();return}var c=prompt("请输入存档密码：");if(c==null||c==""){core.ui.drawSyncSave();return}core.ui.drawWaiting("正在同步，请稍后...");var a=new FormData();a.append("type","load");a.append("name",core.firstData.name);a.append("id",b);a.append("password",c);var d=new XMLHttpRequest();d.open("POST","/games/sync.php");d.onload=function(g){if(d.status==200){var k=JSON.parse(d.response);switch(k.code){case 0:var f=JSON.parse(k.msg);if(f instanceof Array){core.status.event.selection=1;core.ui.drawConfirmBox("所有本地存档都将被覆盖，确认？",function(){for(var e=1;e<=150;e++){if(e<=f.length){core.setLocalStorage("save"+e,f[e-1])}else{core.removeLocalStorage("save"+e)}}core.drawText("同步成功！\n你的本地所有存档均已被覆盖。")},function(){core.status.event.selection=0;core.ui.drawSyncSave()})}else{var j=150;for(var h=150;h>=1;h--){if(core.getLocalStorage("save"+h,null)==null){j=h}else{break}}core.setLocalStorage("save"+j,f);core.drawText("同步成功！\n单存档已覆盖至存档"+j)}break;case -1:core.drawText("出错啦！\n存档编号"+b+"不存在！");break;case -2:core.drawText("出错啦！\n存档密码错误！");break;default:core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因："+k.msg);break}}else{core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因：HTTP "+d.status)}};d.ontimeout=function(){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因：Timeout")};d.onerror=function(){core.drawText("出错啦！\n无法从服务器同步存档。\n错误原因：XHR Error")};d.send(a)};core.prototype.saveData=function(b){var a={floorId:core.status.floorId,hero:core.clone(core.status.hero),hard:core.status.hard,maps:core.maps.save(core.status.maps),route:core.encodeRoute(core.status.route),shops:{},version:core.firstData.version,time:new Date().getTime()};for(var c in core.status.shops){a.shops[c]={times:core.status.shops[c].times||0,visited:core.status.shops[c].visited||false}}core.events.beforeSaveData(a);return core.setLocalStorage(b,a)};core.prototype.loadData=function(b,a){core.resetStatus(b.hero,b.hard,b.floorId,core.decodeRoute(b.route),core.maps.load(b.maps));for(var c in core.status.shops){if(core.isset(b.shops[c])){core.status.shops[c].times=b.shops[c].times;core.status.shops[c].visited=b.shops[c].visited}}core.events.afterLoadData(b);core.changeFloor(b.floorId,null,b.hero.loc,0,function(){if(core.isset(a)){a()}})};core.prototype.encodeRoute=function(e){var a="";var d="",b=0;var c=Object.keys(core.material.items).sort();var f=Object.keys(core.initStatus.shops).sort();e.forEach(function(h){if(h=="up"||h=="down"||h=="left"||h=="right"){if(h!=d&&b>0){a+=d.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}d=h;b++}else{if(b>0){a+=d.substring(0,1).toUpperCase();if(b>1){a+=b}b=0}if(h.indexOf("item:")==0){a+="I"+c.indexOf(h.substring(5))}else{if(h.indexOf("fly:")==0){a+="F"+core.floorIds.indexOf(h.substring(4))}else{if(h.indexOf("choices:")==0){a+="C"+h.substring(8)}else{if(h.indexOf("shop:")==0){var g=h.substring(5).split(":");a+="S"+f.indexOf(g[0])+":"+g[1]}else{if(h=="turn"){a+="T"}else{if(h=="getNext"){a+="G"}else{if(h.indexOf("input:")==0){a+="P"+h.substring(6)}else{if(h=="no"){a+="N"}else{if(h.indexOf("move:")==0){a+="M"+h.substring(5)}}}}}}}}}}});if(b>0){a+=d.substring(0,1).toUpperCase();if(b>1){a+=b}}return a};core.prototype.decodeRoute=function(j){if(!core.isset(j)){return j}var a=[],f=0;var d=function(c){var i="";while(f<j.length&&!isNaN(j.charAt(f))){i+=j.charAt(f++)}if(i.length==0){i="1"}return core.isset(c)?i:parseInt(i)};var g=Object.keys(core.material.items).sort();var k=Object.keys(core.initStatus.shops).sort();while(f<j.length){var b=j.charAt(f++);var h=d();switch(b){case"U":for(var e=0;e<h;e++){a.push("up")}break;case"D":for(var e=0;e<h;e++){a.push("down")}break;case"L":for(var e=0;e<h;e++){a.push("left")}break;case"R":for(var e=0;e<h;e++){a.push("right")}break;case"I":a.push("item:"+g[h]);break;case"F":a.push("fly:"+core.floorIds[h]);break;case"C":a.push("choices:"+h);break;case"S":++f;a.push("shop:"+k[h]+":"+d(true));break;case"T":a.push("turn");break;case"G":a.push("getNext");break;case"P":a.push("input:"+h);break;case"N":a.push("no");break;case"M":++f;a.push("move:"+h+":"+d());break}}return a};core.prototype.setStatus=function(a,b){core.status.hero[a]=b};core.prototype.getStatus=function(a){return core.status.hero[a]};core.prototype.getLvName=function(){if(core.status.hero.lv>core.firstData.levelUp.length){return core.status.hero.lv}return core.firstData.levelUp[core.status.hero.lv-1].name||core.status.hero.lv};core.prototype.setFlag=function(a,b){if(!core.isset(core.status.hero)){return}core.status.hero.flags[a]=b};core.prototype.getFlag=function(b,a){if(!core.isset(core.status.hero)){return a}var c=core.status.hero.flags[b];if(core.isset(c)){return c}return a};core.prototype.hasFlag=function(a){if(core.getFlag(a)){return true}return false};core.prototype.insertAction=function(b,c,d,a){core.events.insertAction(b,c,d,a)};core.prototype.lockControl=function(){core.status.lockControl=true};core.prototype.unLockControl=function(){core.status.lockControl=false};core.prototype.isset=function(a){if(a==undefined||a==null||(typeof a=="number"&&isNaN(a))){return false}return true};core.prototype.readFile=function(b,a){if(!core.platform.isOnline){alert("离线状态下不支持文件读取！");if(core.isset(a)){a()}return}if(core.platform.fileReader==null){alert("当前浏览器不支持FileReader！");if(core.isset(a)){a()}return}if(core.platform.fileInput==null){core.platform.fileInput=document.createElement("input");core.platform.fileInput.style.display="none";core.platform.fileInput.type="file";core.platform.fileInput.onchange=function(){var c=core.platform.fileInput.files;if(c.length==0){if(core.isset(core.platform.errorCallback)){core.platform.errorCallback()}return}core.platform.fileReader.readAsText(core.platform.fileInput.files[0]);core.platform.fileInput.value=""}}core.platform.successCallback=b;core.platform.errorCallback=a;core.platform.fileInput.click()};core.prototype.download=function(d,b){if(!core.platform.isOnline){alert("离线状态下不支持下载操作！");return}if(core.platform.isIOS){alert("iOS平台下不支持下载操作！");return}if(!core.platform.isPC){if(!core.platform.isChrome||core.platform.isQQ||core.platform.isWeChat){if(core.copy(b)){alert("移动端只有Chrome浏览器支持直接下载文件！\n所有应下载内容已经复制到您的剪切板，请自行创建空白文件并粘贴。")}else{alert("该平台或浏览器暂不支持下载操作！")}return}}if(core.platform.isSafari){alert("你当前使用的是Safari浏览器，不支持直接下载文件。\n即将打开一个新窗口为应下载内容，请自行全选复制然后创建空白文件并粘贴。");var a=new Blob([b],{type:"text/plain;charset=utf-8"});var e=window.URL.createObjectURL(a);var f=window.open(e,"_blank");window.URL.revokeObjectURL(e);return}var a=new Blob([b],{type:"text/plain;charset=utf-8"});if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(a,d)}else{var e=window.URL.createObjectURL(a);var c=window.document.createElement("a");c.href=e;c.download=d;document.body.appendChild(c);c.click();document.body.removeChild(c);window.URL.revokeObjectURL(e)}};core.prototype.copy=function(a){if(!core.platform.supportCopy){return false}var d=document.createElement("textarea");d.style.position="fixed";d.style.top=0;d.style.left=0;d.style.width="2em";d.style.height="2em";d.style.padding=0;d.style.border="none";d.style.outline="none";d.style.boxShadow="none";d.style.background="transparent";d.value=a;document.body.appendChild(d);d.select();var c=false;try{c=document.execCommand("copy")}catch(b){c=false}document.body.removeChild(d);return c};core.prototype.playBgm=function(a){if(!core.musicStatus.bgmStatus){return}if(!core.isset(core.material.bgms[a])){return}if(core.material.bgms[a]=="loading"){core.material.bgms[a]="starting";return}try{if(core.musicStatus.playingBgm==a&&core.musicStatus.isPlaying){return}if(core.isset(core.musicStatus.playingBgm)&&core.musicStatus.isPlaying){core.material.bgms[core.musicStatus.playingBgm].pause()}core.musicStatus.playingBgm=a;core.material.bgms[a].play();core.musicStatus.isPlaying=true}catch(b){console.log("无法播放BGM "+a);console.log(b);core.musicStatus.playingBgm=null}};core.prototype.pauseBgm=function(){try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].pause()}core.musicStatus.isPlaying=false}catch(a){console.log("无法暂停BGM "+bgm);console.log(a)}};core.prototype.resumeBgm=function(){if(!core.musicStatus.bgmStatus){return}try{if(core.isset(core.musicStatus.playingBgm)){core.material.bgms[core.musicStatus.playingBgm].play();core.musicStatus.isPlaying=true}else{if(core.bgms.length>0){core.playBgm(core.bgms[0]);core.musicStatus.isPlaying=true}}}catch(a){console.log("无法恢复BGM "+bgm);console.log(a)}};core.prototype.playSound=function(d){if(!core.musicStatus.soundStatus){return}if(!core.isset(core.material.sounds[d])){return}try{if(core.musicStatus.audioContext!=null){var f=core.musicStatus.audioContext.createBufferSource();f.buffer=core.material.sounds[d];f.connect(core.musicStatus.audioContext.destination);try{f.start(0)}catch(a){try{f.noteOn(0)}catch(b){}}}else{core.material.sounds[d].play()}}catch(c){console.log("无法播放SE "+bgm);console.log(c)}};core.prototype.show=function(b,e,a){if(!core.isset(e)){b.style.display="block";return}b.style.display="block";b.style.opacity=0;var c=0;var d=window.setInterval(function(){c+=0.03;b.style.opacity=c;if(c>1){clearInterval(d);if(core.isset(a)){a()}}},e)};core.prototype.hide=function(c,e,a){if(!core.isset(e)){c.style.display="none";return}var d=1;var b=window.setInterval(function(){d-=0.03;c.style.opacity=d;if(d<0){c.style.display="none";clearInterval(b);if(core.isset(a)){a()}}},e)};core.prototype.clearStatusBar=function(){var a=["floor","lv","hp","atk","def","mdef","money","experience","up","yellowKey","blueKey","redKey","poison","weak","curse","hard"];a.forEach(function(b){core.statusBar[b].innerHTML="&nbsp;"});core.statusBar.image.book.style.opacity=0.3;core.statusBar.image.fly.style.opacity=0.3};core.prototype.updateStatusBar=function(){core.events.checkLvUp();if(core.values.HPMAX>0){core.setStatus("hp",Math.min(core.values.HPMAX,core.getStatus("hp")))}core.updateCheckBlock();var b=core.getLvName();core.statusBar.lv.innerHTML=b;if(/^[+-]?\d+$/.test(b)){core.statusBar.lv.style.fontStyle="italic"}else{core.statusBar.lv.style.fontStyle="normal"}var c=["hp","atk","def","mdef","money","experience"];c.forEach(function(d){core.statusBar[d].innerHTML=core.getStatus(d)});if(core.flags.enableLevelUp&&core.status.hero.lv<core.firstData.levelUp.length){core.statusBar.up.innerHTML=core.firstData.levelUp[core.status.hero.lv].need||"&nbsp;"}else{core.statusBar.up.innerHTML="&nbsp;"}var a=["yellowKey","blueKey","redKey"];a.forEach(function(d){core.statusBar[d].innerHTML=core.setTwoDigits(core.status.hero.items.keys[d])});if(core.flags.enableDebuff){core.statusBar.poison.innerHTML=core.hasFlag("poison")?"毒":"";core.statusBar.weak.innerHTML=core.hasFlag("weak")?"衰":"";core.statusBar.curse.innerHTML=core.hasFlag("curse")?"咒":""}core.statusBar.hard.innerHTML=core.status.hard;if(core.status.replay.replaying){core.statusBar.image.book.src=core.status.replay.pausing?core.statusBar.icons.play.src:core.statusBar.icons.pause.src;core.statusBar.image.book.style.opacity=1;core.statusBar.image.fly.src=core.statusBar.icons.stop.src;core.statusBar.image.fly.style.opacity=1;core.statusBar.image.toolbox.style.opacity=0;core.statusBar.image.shop.style.opacity=0;core.statusBar.image.save.src=core.statusBar.icons.rewind.src;core.statusBar.image.save.style.opacity=1;core.statusBar.image.load.src=core.statusBar.icons.forward.src;core.statusBar.image.load.style.opacity=1;core.statusBar.image.settings.style.opacity=0}else{core.statusBar.image.book.src=core.statusBar.icons.book.src;core.statusBar.image.book.style.opacity=core.hasItem("book")?1:0.3;core.statusBar.image.fly.src=core.statusBar.icons.fly.src;core.statusBar.image.fly.style.opacity=core.hasItem("fly")?1:0.3;core.statusBar.image.toolbox.src=core.statusBar.icons.toolbox.src;core.statusBar.image.toolbox.style.opacity=1;core.statusBar.image.shop.style.opacity=1;core.statusBar.image.save.src=core.statusBar.icons.save.src;core.statusBar.image.save.style.opacity=1;core.statusBar.image.load.src=core.statusBar.icons.load.src;core.statusBar.image.load.style.opacity=1;core.statusBar.image.settings.src=core.statusBar.icons.settings.src;core.statusBar.image.settings.style.opacity=1}core.updateFg()};core.prototype.resize=function(i,h){var m=422;var l=132;var c=32;var v=3;var n=16;var a=m;var g=m+l;var S=i;var r=false;if(i>h&&h<a){r=true;S=h}var q,p,d,f,e,y,x,w,E,z,D,A,M,K,L,I,Q,N,O,P,o,J,s;var k=11;if(!core.flags.enableFloor){k--}if(!core.flags.enableLv){k--}if(!core.flags.enableMDef){k--}if(!core.flags.enableMoney){k--}if(!core.flags.enableExperience){k--}if(!core.flags.enableLevelUp){k--}if(!core.flags.enableDebuff){k--}var C=c*9/k;var B=n;if(k>9){B=B*9/k}var u;w="3px #fff solid";I="3px #fff solid";var T=(a-S)/4.22;var b=1-T/100;if(S<g){if(S<a){core.domStyle.scale=b;f=S}else{f=m;core.domStyle.scale=1}var t=core.domStyle.scale;var H=m*t;if(!r){core.domStyle.screenMode="vertical";u="block";var j=parseInt((k-1)/3)+1;var G=t*(c*j+v*2)+6;var F=t*(c+v*4)+6;p=H+G+F;q=H;e=G;M=y=f;x=G;w="3px #fff solid";z=t*c*0.8;A=0.8*c*t;D=t*l*0.95;K=F;L=x+f;I="3px #fff solid";N=t*c;P=t*l*0.4;d="3px #fff solid";s=t*v*2;O=t*v*4;o=n*t;J=n*t}else{core.domStyle.screenMode="horizontal";u="none";q=H+l*t;p=H;e=0;M=y=l*t;x=t*C*k+v*2;w="3px #fff solid";z=t*C*0.8;A=0.8*C*t;K=f-x;L=t*C*k+v*2;I="3px #fff solid";N=t*c;o=B*t;J=n*t;d="";D=t*l;P=t*l;s=t*v*2;O=2*v*t}}else{core.domStyle.scale=1;core.domStyle.screenMode="bigScreen";u="none";q=m+l;p=m;f=m;e=0;M=y=l;x=C*k+v*2;z=C*0.8;A=0.8*C;K=m-x;L=C*k+v*2;N=c;d="";o=B;J=n;D=l;P=l*0.9;s=v*2;O=2*v}var R="px";core.domStyle.styles=[{id:"gameGroup",rules:{width:q+R,height:p+R,top:(h-p)/2+R,left:(i-q)/2+R,}},{className:"gameCanvas",rules:{width:f+R,height:f+R,top:e+R,right:0,border:"3px #fff solid",}},{id:"curtain",rules:{width:(f-v*2)+R,height:(f-v*2)+R,top:(e+v)+R,right:v+R,}},{id:"floorMsgGroup",rules:{width:(f-v*2)+R,height:(p-v*2)+R,top:v+R,right:v+R,}},{id:"statusBar",rules:{width:y+R,height:x+R,top:0,left:0,padding:v+R,borderTop:w,borderLeft:w,borderRight:d,fontSize:o+R}},{className:"status",rules:{width:"100%",maxWidth:D+R,height:z+R,margin:s/2+R}},{className:"statusLabels",rules:{marginLeft:s+R,lineHeight:A+R,}},{id:"toolBar",rules:{width:M+R,height:K+R,top:L+R,left:0,padding:v+R,borderBottom:I,borderLeft:I,borderRight:d,fontSize:J+R}},{className:"tools",rules:{height:N+R,maxWidth:P+R,marginLeft:O+R,marginTop:s+R,}},{imgId:"shop",rules:{display:u}},{id:"floorCol",rules:{display:core.flags.enableFloor?"block":"none"}},{id:"lvCol",rules:{display:core.flags.enableLv?"block":"none"}},{id:"mdefCol",rules:{display:core.flags.enableMDef?"block":"none"}},{id:"moneyCol",rules:{display:core.flags.enableMoney?"block":"none"}},{id:"expCol",rules:{display:core.flags.enableExperience?"block":"none"}},{id:"upCol",rules:{display:core.flags.enableLevelUp?"block":"none"}},{id:"debuffCol",rules:{display:core.flags.enableDebuff?"block":"none"}},{id:"hard",rules:{lineHeight:N+R}}];core.domRenderer()};core.prototype.domRenderer=function(){core.dom.statusBar.style.display="block";core.dom.toolBar.style.display="block";var l=core.domStyle.styles;for(var b=0;b<l.length;b++){if(l[b].hasOwnProperty("rules")){var g=l[b].rules;var h=Object.keys(g);if(l[b].hasOwnProperty("className")){var a=l[b].className;for(var e=0;e<core.dom[a].length;e++){for(var f=0;f<h.length;f++){core.dom[a][e].style[h[f]]=g[h[f]]}}}if(l[b].hasOwnProperty("id")){var c=l[b].id;for(var e=0;e<h.length;e++){core.dom[c].style[h[e]]=g[h[e]]}}if(l[b].hasOwnProperty("imgId")){var d=l[b].imgId;for(var e=0;e<h.length;e++){core.statusBar.image[d].style[h[e]]=g[h[e]]}}}}};var core=new core();main.instance.core=core;